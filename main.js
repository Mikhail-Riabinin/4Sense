"use strict";var R=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var tt=Object.prototype.hasOwnProperty;var et=(y,t)=>{for(var e in t)R(y,e,{get:t[e],enumerable:!0})},st=(y,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Z(t))!tt.call(y,a)&&a!==e&&R(y,a,{get:()=>t[a],enumerable:!(s=Q(t,a))||s.enumerable});return y};var at=y=>st(R({},"__esModule",{value:!0}),y);var yt={};et(yt,{default:()=>A});module.exports=at(yt);var c=require("obsidian"),it={apiHost:"",apiKey:"",apiSummaryPath:"/summaries",apiTranscriptionPath:"/transcriptions",apiChatPath:"/chat",summaryFileName:"_summary.md",chatTheme:"quiet"},nt="You are a helpful assistant. Use the provided folder summary as context.",rt=new Set(["mp3","wav","m4a","ogg","flac","opus"]),ot=new Set(["png","jpg","jpeg","gif","webp"]),lt=new Set(["mp3","wav","m4a","aac","ogg","flac","opus","webm"]),ct=10*1024*1024,K="4senseContext",J="artefacts",U="chat-",ht="chat-state.json",q="snapshot.json",ut=120,mt=Math.max(24,Math.floor(ut/4)),dt=2,pt=20,j="websocket",gt="True",ft=8e3,A=class extends c.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new N(this.app,this)),this.addCommand({id:"summarize-folder-select",name:"Summarize folder (select)",callback:()=>this.openFolderSelectModal(t=>this.summarizeFolder(t))}),this.addCommand({id:"summarize-current-folder",name:"Summarize current file folder",callback:()=>this.summarizeCurrentFileFolder()}),this.app.workspace.onLayoutReady(()=>this.registerUiActions())}onunload(){}async summarizeCurrentFileFolder(){let t=this.getCurrentFileFolder();if(!t){new c.Notice("No active file to determine folder.");return}await this.summarizeFolder(t)}getCurrentFileFolder(){let t=this.app.workspace.getActiveFile();if(!t)return null;let e=t.parent;return e instanceof c.TFolder?e:null}openFolderSelectModal(t){new I(this.app,t).open()}registerUiActions(){this.addRibbonIcon("sparkles","Chat with assistant",()=>{this.openFolderSelectModal(e=>this.openChatForFolder(e))}),this.registerEvent(this.app.workspace.on("file-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(n=>n.setTitle("4Sense: Chat with assistant").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}));let t=this.app.workspace;this.registerEvent(t.on("file-explorer-context-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(n=>n.setTitle("4Sense: Chat with assistant").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}))}resolveFolderFromAbstractFile(t){return t?t instanceof c.TFolder?t:t instanceof c.TFile&&t.parent instanceof c.TFolder?t.parent:null:null}async summarizeFolder(t,e){let s=new O(this.app);s.open();try{s.setStatus("\u0421\u043A\u0430\u043D\u0438\u0440\u0443\u044E \u0444\u0430\u0439\u043B\u044B...");let a=e??this.collectFilesInFolder(t),{textFiles:n,audioFiles:i,imageFiles:r,unsupportedAudioFiles:o,skippedFiles:l}=this.splitFiles(a);if(n.length===0&&i.length===0&&r.length===0){new c.Notice("No supported files found in the selected folder.");return}if(o.length>0){let g=o.map(f=>f.name).slice(0,3).join(", "),w=o.length>3?` (+${o.length-3} more)`:"";new c.Notice(`Unsupported audio formats: ${g}${w}`)}l.length>0&&new c.Notice(`Skipping ${l.length} unsupported files.`),s.setStatus("\u0413\u043E\u0442\u043E\u0432\u043B\u044E \u0434\u0430\u043D\u043D\u044B\u0435...");let h=await this.buildSummaryPayload(t,a,i.length,r,g=>s.setStatus(g));s.setStatus("\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u044E \u0434\u0430\u043D\u043D\u044B\u0435 \u043D\u0430 \u0441\u0443\u043C\u043C\u0430\u0440\u0438\u0437\u0430\u0446\u0438\u044E...");let u=await this.callSummaryApi(h);s.setStatus("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u044E \u0441\u0430\u043C\u043C\u0430\u0440\u0438..."),await this.writeSummaryFile(t,u),await this.writeSnapshot(t,a),new c.Notice("Summary saved.")}catch(a){this.showErrorModal(a)}finally{s.close()}}collectFilesInFolder(t){let e=this.getContextPath(t),s=this.getArtifactsPath(t),a=`${e}/${this.settings.summaryFileName}`,n=[],i=r=>{for(let o of r.children){if(o instanceof c.TFolder){if(o.path===e||o.path.startsWith(`${e}-`)||o.path===s||o.path.startsWith(`${s}/`))continue;i(o);continue}o instanceof c.TFile&&(o.path===a||o.path.startsWith(`${e}/`)||o.path.startsWith(`${e}-`)||o.path.startsWith(`${s}/`)||n.push(o))}};return i(t),n.sort((r,o)=>r.stat.ctime-o.stat.ctime),n}async buildSummaryPayload(t,e,s,a,n){let i=[],r=new Set(a.map(l=>l.path)),o=0;for(let l of e){if(this.isMarkdownFile(l)){let h=await this.app.vault.read(l);i.push({path:l.path,kind:this.isExcalidrawFile(l)?"excalidraw":"markdown",content:h});continue}if(r.has(l.path)){if(l.stat.size>ct){n&&n(`\u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u044E \u0431\u043E\u043B\u044C\u0448\u043E\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);continue}n&&n(`\u0414\u043E\u0431\u0430\u0432\u043B\u044F\u044E \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);let u=V(await this.app.vault.readBinary(l));i.push({path:l.path,kind:"image",content:u});continue}if(this.isSupportedAudioFile(l)){o+=1,n&&n(`\u0422\u0440\u0430\u043D\u0441\u043A\u0440\u0438\u0431\u0438\u0440\u0443\u044E \u0430\u0443\u0434\u0438\u043E ${o}/${s}: ${l.name}`);let h=await this.callTranscriptionApi(l);if(!h)continue;i.push({path:l.path,kind:"audio_transcript",content:h})}}return{folderPath:t.path,files:i}}async callSummaryApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in plugin settings.");let e=this.buildApiUrl(this.settings.apiSummaryPath),s={"Content-Type":"application/json"};this.settings.apiKey&&(s.Authorization=`Bearer ${this.settings.apiKey}`);let a=await this.requestJson(e,s,t);if(typeof a=="object"&&a!==null&&typeof a.summary=="string")return a.summary;throw new Error("Summary API returned an unexpected response.")}async writeSummaryFile(t,e){await this.ensureContextFolder(t);let s=this.getSummaryFilePath(t);await this.replaceTextFile(s,e)}async replaceTextFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s instanceof c.TFile){await this.app.vault.process(s,()=>e);return}await this.app.vault.create(t,e)}async appendTextFile(t,e,s=""){let a=this.app.vault.getAbstractFileByPath(t);if(a instanceof c.TFile){await this.app.vault.process(a,n=>n+e);return}await this.app.vault.create(t,`${s}${e}`)}async openChatForFolder(t){try{let e=this.collectFilesInFolder(t),s=await this.getSnapshotState(t,e);s.changed?(await this.archiveContextFolder(t),await this.ensureContextFolder(t),await this.writeSnapshot(t,e)):s.exists||(await this.ensureContextFolder(t),await this.writeSnapshot(t,e)),await this.ensureContextFolder(t),await this.ensureArtifactsFolder(t);let a=await this.readSummaryFile(t);if(a||(await this.summarizeFolder(t,e),a=await this.readSummaryFile(t)),!a){new c.Notice("Summary file not found. Unable to open chat.");return}let n=await this.getOrCreateChatLog(t),i=await this.loadChatHistory(n);if(i.length===0){let o=await this.findChatHistory(t,n,!0);o&&(i=this.stripTimestamps(o.entries),await this.writeChatLog(n,o.entries))}new H(this.app,this,a,t.name||t.path||"",t.path??"",this.settings.chatTheme,i,async(o,l,h,u)=>this.callChatApiStream(l,o,h,u),async o=>this.saveAssistantResponse(t,o),async(o,l)=>this.appendChatLog(n,o,l),async(o,l)=>this.downloadArtifacts(t,o,l)).open()}catch(e){this.showErrorModal(e)}}async readSummaryFile(t){let e=this.getSummaryFilePath(t),s=this.app.vault.getAbstractFileByPath(e);return s instanceof c.TFile?this.app.vault.read(s):null}async callChatApi(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let a=this.buildApiUrl(this.settings.apiChatPath),n={"Content-Type":"application/json"};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`);let i=await this.requestJson(a,n,{summary:t,messages:this.stripTimestamps(e)},s),r=typeof i=="object"&&i!==null?i.message??i.response??i.content:void 0;if(typeof r=="string")return{message:r,artifactPaths:this.extractArtifactPaths(r)};throw new Error("Chat API returned an unexpected response.")}async callChatApiStream(t,e,s,a){try{return await this.callChatApiWebSocket(t,e,s,a)}catch(n){if(this.isAbortError(n))throw n;let i=await this.callChatApi(t,e,a);return i.message.length>0&&s(i.message),i}}async callChatApiWebSocket(t,e,s,a){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");if(typeof WebSocket!="function")throw new Error("WebSocket is not available in this environment.");let n=this.buildChatWebSocketUrl(),i=JSON.stringify({summary:t,messages:this.stripTimestamps(e),apiKey:this.settings.apiKey||void 0});return new Promise((r,o)=>{let l=!1,h="",u=new WebSocket(n),g=()=>{u.onopen=null,u.onmessage=null,u.onerror=null,u.onclose=null,a&&a.removeEventListener("abort",S),window.clearTimeout(b)},w=m=>{l||(l=!0,g(),r(m))},f=m=>{l||(l=!0,g(),o(m))},C=m=>{w({message:m,artifactPaths:this.extractArtifactPaths(m)})},S=()=>{try{u.close(1e3,"aborted")}catch{}f(new Error("Request aborted"))},T=m=>{if(typeof m=="string"){let v=m.trim();if(v==="[DONE]"||v==="__DONE__"){C(h);try{u.close(1e3,"done")}catch{}return}h+=m,s(m);return}if(!m||typeof m!="object")return;let d=m;if(d.type==="error"){let v=typeof d.message=="string"?d.message:typeof d.error=="string"?d.error:"Chat websocket error.";throw new Error(v)}if(d.type==="chunk"){let v=typeof d.text=="string"?d.text:"";v.length>0&&(h+=v,s(v));return}if(d.type==="done"||d.done===!0){C(h);try{u.close(1e3,"done")}catch{}return}let E=typeof d.message=="string"?d.message:typeof d.response=="string"?d.response:typeof d.content=="string"?d.content:typeof d.text=="string"?d.text:null;E!==null&&(h+=E,s(E))},b=window.setTimeout(()=>{try{u.close()}catch{}f(new Error("WebSocket connection timed out."))},ft);if(a){if(a.aborted){S();return}a.addEventListener("abort",S,{once:!0})}u.onopen=()=>{window.clearTimeout(b),u.send(i)},u.onmessage=m=>{if(!l)try{if(typeof m.data=="string"){let d=m.data;try{T(JSON.parse(d))}catch{T(d)}return}if(m.data instanceof ArrayBuffer){let d=new TextDecoder().decode(m.data);try{T(JSON.parse(d))}catch{T(d)}return}T(String(m.data??""))}catch(d){f(d instanceof Error?d:new Error("Failed to process websocket frame."))}},u.onerror=()=>{f(new Error("WebSocket connection failed."))},u.onclose=m=>{if(!l){if(m.code===1e3){C(h);return}if(h.length>0){C(h);return}f(new Error(`WebSocket closed with code ${m.code}.`))}}})}async callTranscriptionApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let e=this.buildApiUrl(this.settings.apiTranscriptionPath),s=await this.app.vault.readBinary(t),a=this.getAudioContentType(t),n={path:t.path,name:t.name,data:V(s),contentType:a},i={"Content-Type":"application/json"};this.settings.apiKey&&(i.Authorization=`Bearer ${this.settings.apiKey}`),i["X-Audio-Content-Type"]=a;let r=await this.requestJson(e,i,n),o=typeof r=="object"&&r!==null?r.text??r.transcript??r.transcription??null:null;if(typeof o=="string"&&o.length>0)return o;throw new Error("Transcription API returned an unexpected response.")}async loadSettings(){this.settings=Object.assign({},it,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}buildApiUrl(t){let e=this.settings.apiHost.trim(),s=e.endsWith("/")?e:`${e}/`,a=t.trim().replace(/^\/+/u,"");return new URL(a,s).toString()}buildChatWebSocketUrl(){let t=this.buildApiUrl(this.settings.apiChatPath),e=new URL(t);return e.protocol=e.protocol==="https:"?"wss:":"ws:",e.searchParams.has(j)||e.searchParams.set(j,gt),e.toString()}getContextPath(t){return`${t.path?`${t.path}/`:""}${K}`}getArtifactsPath(t){return`${this.getContextPath(t)}/${J}`}getSummaryFilePath(t){return`${this.getContextPath(t)}/${this.settings.summaryFileName}`}async ensureFolderExists(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFolder)){if(e)throw new Error(`Path exists but is not a folder: ${t}`);await this.app.vault.createFolder(t)}}async ensureContextFolder(t){await this.ensureFolderExists(this.getContextPath(t))}async ensureArtifactsFolder(t){await this.ensureFolderExists(this.getArtifactsPath(t))}async requestJson(t,e,s,a){let n=await(0,c.requestUrl)({url:t,method:"POST",headers:e,body:JSON.stringify(s)});if(n.status<200||n.status>=300){let i=this.extractErrorDetail(n);throw new Error(i??`API error: ${n.status}`)}if(n.json)return n.json;try{return JSON.parse(n.text)}catch{throw new Error("API returned non-JSON response.")}}extractErrorDetail(t){let e=typeof t.json=="object"&&t.json!==null?t.json:null,s=e?.detail??e?.message;return typeof s=="string"&&s.trim().length>0?s.trim():t.text&&t.text.trim().length>0?t.text.trim():null}showErrorModal(t){let e=t instanceof Error?t.message:typeof t=="string"?t:"Unknown error.";new z(this.app,e).open()}isAbortError(t){return t instanceof Error?t.message.toLowerCase().includes("abort"):!1}async getSnapshotState(t,e){let s=await this.readSnapshot(t);if(!s)return{exists:!1,changed:!1};let a=new Map(e.map(n=>[n.path,n.stat.mtime]));if(s.files.length!==a.size)return{exists:!0,changed:!0};for(let n of s.files){let i=a.get(n.path);if(i===void 0||i!==n.mtime)return{exists:!0,changed:!0}}return{exists:!0,changed:!1}}async readSnapshot(t){let e=`${this.getContextPath(t)}/${q}`,s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s);return JSON.parse(a)}catch{return null}}async writeSnapshot(t,e){await this.ensureContextFolder(t);let s={files:e.map(i=>({path:i.path,mtime:i.stat.mtime}))},a=`${this.getContextPath(t)}/${q}`,n=JSON.stringify(s,null,2);await this.replaceTextFile(a,n)}async archiveContextFolder(t){let e=this.getContextPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFolder))return;let a=`${e}-${this.formatTimestamp(new Date)}`;await this.app.vault.rename(s,a)}async getOrCreateChatLog(t){await this.ensureContextFolder(t);let e=await this.readChatState(t);if(e?.activeLogPath){let i=this.app.vault.getAbstractFileByPath(e.activeLogPath);if(i instanceof c.TFile&&i.extension==="md")return e.activeLogPath}let s=this.getLatestChatLogPath(t);if(s)return await this.writeChatState(t,s),s;let a=`${U}${this.formatTimestamp(new Date)}.md`,n=`${this.getContextPath(t)}/${a}`;return await this.app.vault.create(n,`# Chat history

`),await this.writeChatState(t,n),n}getLatestChatLogPath(t){let e=this.getChatLogCandidates(t);return e.length===0?null:(e.sort((s,a)=>a.stat.mtime-s.stat.mtime),e[0].path)}getChatLogCandidates(t,e=!1){let s=this.getContextPath(t),a=[],n=o=>e?o.extension==="md"||o.extension==="json":o.extension==="md",i=o=>{for(let l of o.children){if(l instanceof c.TFolder){i(l);continue}l instanceof c.TFile&&l.name.startsWith(U)&&n(l)&&a.push(l)}},r=t.children.filter(o=>o instanceof c.TFolder&&(o.path===s||o.path.startsWith(`${s}-`)));for(let o of r)i(o);return a}async findChatHistory(t,e,s){let a=this.getChatLogCandidates(t,s);if(a.length===0)return null;a.sort((n,i)=>i.stat.mtime-n.stat.mtime);for(let n of a){if(n.path===e)continue;let i=await this.loadChatEntries(n.path);if(i.length>0)return{path:n.path,entries:i}}return null}async loadChatHistory(t){let e=await this.loadChatEntries(t);return this.stripTimestamps(e)}async loadChatEntries(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFile))return[];let s=await this.app.vault.read(e);return this.parseChatLog(s)}parseChatLog(t){let e=t.trim();if(e.startsWith("{")||e.startsWith("["))try{let l=JSON.parse(e),h=Array.isArray(l)?l:l.messages??l.history??l.items??l.log??[];return(Array.isArray(h)?h:[]).map(g=>{if(!g||typeof g!="object")return null;let w=g,f=w.role??w.type??w.author??w.sender??null;if(f!=="user"&&f!=="assistant"&&f!=="system")return null;let C=w.content??w.text??w.message??"";return typeof C!="string"?null:{role:f,content:C,timestamp:this.extractTimestamp(w)}}).filter(g=>!!g)}catch{}let s=[],a=t.split(/\r?\n/),n=null,i,r=[],o=()=>{if(n&&r.length>0){let l=r.join(`
`).trim();l.length>0&&s.push({role:n,content:l,timestamp:i})}};for(let l of a){let h=l.match(/^## \[(.+)\] (user|assistant)$/u);if(h){o(),n=h[2],i=h[1],r=[];continue}l.startsWith("# Chat history")||r.push(l)}return o(),s}async appendChatLog(t,e,s){let n=`## [${new Date().toISOString()}] ${e}
${s}

`;await this.appendTextFile(t,n,`# Chat history

`)}async writeChatLog(t,e){let s=`# Chat history

`,a=e.filter(i=>i.role==="user"||i.role==="assistant").map(i=>`## [${i.timestamp??new Date().toISOString()}] ${i.role}
${i.content}

`).join(""),n=s+a;await this.replaceTextFile(t,n)}stripTimestamps(t){return t.map(e=>({role:e.role,content:e.content}))}extractTimestamp(t){let e=t.timestamp??t.time??t.created_at??t.createdAt??t.date??t.ts??null;return this.normalizeTimestamp(e)??void 0}normalizeTimestamp(t){if(typeof t=="string"){let e=new Date(t);return Number.isNaN(e.getTime())?null:e.toISOString()}if(typeof t=="number"&&Number.isFinite(t)){let e=t<1e12?t*1e3:t,s=new Date(e);if(!Number.isNaN(s.getTime()))return s.toISOString()}return null}getChatStatePath(t){return`${this.getContextPath(t)}/${ht}`}async readChatState(t){let e=this.getChatStatePath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s);return JSON.parse(a)}catch{return null}}async writeChatState(t,e){await this.ensureContextFolder(t);let s=this.getChatStatePath(t),a=JSON.stringify({activeLogPath:e},null,2);await this.replaceTextFile(s,a)}extractArtifactPaths(t){let e=t.split(/\r?\n/),s=[],a=!1;for(let n of e){let i=n.trim();if(i.startsWith("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B:")){a=!0;continue}if(!a)continue;let r=i.match(/^-\s*(\/artifacts\/\S+)/u);if(r){s.push(r[1]);continue}if(i.length>0)break}return s}async downloadArtifacts(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");await this.ensureArtifactsFolder(t);for(let a of e){s(a,"\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430");try{let n=this.buildApiUrl(a),i={};this.settings.apiKey&&(i.Authorization=`Bearer ${this.settings.apiKey}`);let r=await(0,c.requestUrl)({url:n,method:"GET",headers:i});if(r.status<200||r.status>=300)throw new Error(`Artifact download failed: ${r.status}`);let o=r.arrayBuffer??new TextEncoder().encode(r.text??"").buffer,l=this.getArtifactFilename(a),h=`${this.getArtifactsPath(t)}/${l}`,u=this.app.vault.getAbstractFileByPath(h);u instanceof c.TFile?await this.app.vault.modifyBinary(u,o):await this.app.vault.createBinary(h,o),s(a,"\u0433\u043E\u0442\u043E\u0432\u043E")}catch{s(a,"\u043E\u0448\u0438\u0431\u043A\u0430")}}}getArtifactFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}splitFiles(t){let e=[],s=[],a=[],n=[],i=[];for(let r of t){if(this.isSupportedAudioFile(r)){s.push(r);continue}if(this.isImageFile(r)){a.push(r);continue}if(this.isAnyAudioFile(r)){n.push(r);continue}if(this.isMarkdownFile(r)){e.push(r);continue}i.push(r)}return{textFiles:e,audioFiles:s,imageFiles:a,unsupportedAudioFiles:n,skippedFiles:i}}isMarkdownFile(t){return t.extension==="md"}isExcalidrawFile(t){return t.path.endsWith(".excalidraw.md")}isSupportedAudioFile(t){return rt.has(t.extension.toLowerCase())}isAnyAudioFile(t){return lt.has(t.extension.toLowerCase())}isImageFile(t){return ot.has(t.extension.toLowerCase())}getAudioContentType(t){let e=t.extension.toLowerCase();switch(e){case"mp3":case"m4a":return"audio/mpeg";case"ogg":case"opus":return"audio/ogg;codecs=opus";case"flac":return"audio/flac";case"wav":return"audio/x-pcm;bit=16;rate=16000";default:throw new Error(`Unsupported audio format: .${e}`)}}async saveAssistantResponse(t,e){await this.ensureContextFolder(t);let s=`${this.getContextPath(t)}/`,a=this.formatTimestamp(new Date),n=`ai-response-${a}.md`,i=`${s}${n}`,r=1;for(;this.app.vault.getAbstractFileByPath(i);)i=`${s}ai-response-${a}-${r}.md`,r+=1;await this.app.vault.create(i,e),new c.Notice(`Saved response to ${i}`)}formatTimestamp(t){let e=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getFullYear()).slice(-2),n=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return`${e}-${s}-${a}T${n}-${i}-${r}`}},I=class extends c.FuzzySuggestModal{constructor(t,e){super(t),this.onSelect=e,this.folders=this.collectFolders(),this.setPlaceholder("Select a folder to summarize")}getItems(){return this.folders}getItemText(t){return t.path||"/"}onChooseItem(t){this.onSelect(t)}collectFolders(){let t=this.app.vault.getAllLoadedFiles(),e=[];for(let s of t)s instanceof c.TFolder&&e.push(s);return e}},H=class extends c.Modal{constructor(t,e,s,a,n,i,r,o,l,h,u){super(t),this.markdownComponent=e,this.summary=s,this.folderLabel=a,this.theme=i,this.useSummary=!0,this.markdownSourcePath=n,this.onStream=o,this.onSave=l,this.onLog=h,this.onDownloadArtifacts=u,this.messages=[{role:"system",content:nt},...r],this.isWaiting=!1,this.requestCounter=0,this.canceledRequest=null,this.currentAbort=null,this.streamingRenderTarget=null,this.streamingRenderText="",this.streamingTypingTimer=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null,this.viewportTarget=null,this.viewportHandler=null}onOpen(){let{contentEl:t}=this;t.empty(),this.modalEl.addClass("folder-summary-chat-modal"),t.addClass("folder-summary-chat"),this.theme==="glass"&&(this.modalEl.addClass("folder-summary-chat-modal--glass"),t.addClass("folder-summary-chat--glass")),this.theme==="quiet"&&(this.modalEl.addClass("folder-summary-chat-modal--quiet"),t.addClass("folder-summary-chat--quiet"));let e=t.createEl("div");e.addClass("folder-summary-chat__header"),e.createEl("h3",{text:"Chat with assistant"}).addClass("folder-summary-chat__title");let a=e.createEl("button");a.addClass("folder-summary-chat__close"),a.setAttr("aria-label","Close chat"),a.createEl("span",{text:"\xD7"}).addClass("folder-summary-chat__close-glyph"),a.onclick=()=>this.close();let i=t.createEl("div");i.addClass("folder-summary-chat__output"),i.tabIndex=-1;for(let p of this.messages)(p.role==="user"||p.role==="assistant")&&this.appendMessage(i,p.role,p.content);let r=t.createEl("textarea");r.addClass("folder-summary-chat__input"),r.placeholder="Ask a question...";let o=()=>{window.setTimeout(()=>{r.scrollIntoView({block:"nearest",behavior:"auto"})},80)},l=()=>{let p=typeof window.visualViewport?.height=="number"?window.visualViewport.height:window.innerHeight;this.modalEl.style.setProperty("--folder-summary-chat-vh",`${Math.max(320,Math.round(p))}px`)};l();let h=window.visualViewport;if(h){let p=()=>{l(),document.activeElement===r&&o()};h.addEventListener("resize",p),h.addEventListener("scroll",p),this.viewportTarget=h,this.viewportHandler=p}r.addEventListener("focus",()=>{l(),o()});let u=t.createEl("button",{text:"Send"});u.addClass("folder-summary-chat__send");let g=p=>{this.isWaiting=p,r.disabled=p,p?(u.setText("Stop"),u.addClass("folder-summary-chat__send--stop")):(u.setText("Send"),u.removeClass("folder-summary-chat__send--stop"))},w=async()=>{let p=r.value.trim();if(!p||this.isWaiting)return;r.value="",this.appendMessage(i,"user",p),this.messages.push({role:"user",content:p}),await this.onLog("user",p),this.resetStreamingState();let F=this.appendLoadingMessage(i);i.scrollTop=i.scrollHeight,g(!0);let D=++this.requestCounter,B=new AbortController;this.currentAbort=B;let k="",L=!1,M=()=>{L||(L=!0,F.wrapper.removeClass("folder-summary-chat__message--loading"),F.body.empty(),F.body.addClass("folder-summary-chat__message-body--streaming"))};try{let x=await this.onStream(this.messages,this.useSummary?this.summary:"",P=>{M(),k+=P,this.updateStreamingMessage(F.body,k),i.scrollTop=i.scrollHeight},B.signal);if(this.canceledRequest===D)F.wrapper.remove();else{L||M();let P=x.message||k;if(this.messages.push({role:"assistant",content:P}),this.finalizeStreamingMessage(F.body,P),await this.onLog("assistant",P),x.artifactPaths.length>0){let Y=this.renderArtifactStatus(F.wrapper,x.artifactPaths);this.onDownloadArtifacts(x.artifactPaths,(X,W)=>{let $=Y.get(X);$&&($.status.setText(W),$.open.classList.toggle("folder-summary-chat__artifact-open--disabled",W!=="\u0433\u043E\u0442\u043E\u0432\u043E"))})}}}catch(x){if(this.canceledRequest!==D){let P=x instanceof Error?x.message:"Failed to fetch response.";P.toLowerCase().includes("abort")?F.wrapper.remove():(M(),this.updateStreamingMessage(F.body,P))}else F.wrapper.remove()}finally{g(!1),this.canceledRequest=null,this.currentAbort=null}i.scrollTop=i.scrollHeight};u.onclick=()=>{if(this.isWaiting){this.canceledRequest=this.requestCounter,this.currentAbort?.abort(),g(!1);return}w()},r.addEventListener("keydown",p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),w())});let f=t.createEl("div");f.addClass("folder-summary-chat__actions"),f.appendChild(u);let C=f.createEl("button",{text:"Summary"});C.addClass("folder-summary-chat__summary-open");let S=f.createEl("label");S.addClass("folder-summary-chat__summary-toggle");let T=S.createEl("input");T.type="checkbox",T.checked=!0,T.addClass("folder-summary-chat__summary-checkbox"),S.createEl("span").addClass("folder-summary-chat__summary-slider"),S.createEl("span",{text:"Use summary"}).addClass("folder-summary-chat__summary-toggle-label"),T.addEventListener("change",()=>{this.useSummary=T.checked});let m=t.createEl("div");m.addClass("folder-summary-chat__summary-sheet"),m.addClass("folder-summary-chat__summary-sheet--hidden"),m.setAttr("aria-hidden","true");let d=m.createEl("div");d.addClass("folder-summary-chat__summary-panel");let E=d.createEl("div");E.addClass("folder-summary-chat__summary-header"),E.createEl("div",{text:`Summary: ${this.folderLabel}`}).addClass("folder-summary-chat__summary-header-title");let v=E.createEl("button",{text:"Close"});v.addClass("folder-summary-chat__summary-close"),d.createEl("pre",{text:this.summary}).addClass("folder-summary-chat__summary-text");let G=()=>{m.removeClass("folder-summary-chat__summary-sheet--hidden"),m.setAttr("aria-hidden","false"),v.focus()},_=()=>{m.addClass("folder-summary-chat__summary-sheet--hidden"),m.setAttr("aria-hidden","true")};C.onclick=()=>G(),v.onclick=()=>_(),m.addEventListener("click",p=>{p.target===m&&_()}),t.addEventListener("keydown",p=>{p.key==="Escape"&&!m.classList.contains("folder-summary-chat__summary-sheet--hidden")&&(p.preventDefault(),_())}),window.setTimeout(()=>{document.activeElement===a&&i.focus({preventScroll:!0})},0)}onClose(){this.currentAbort?.abort(),this.currentAbort=null,this.resetStreamingState(),this.viewportTarget&&this.viewportHandler&&(this.viewportTarget.removeEventListener("resize",this.viewportHandler),this.viewportTarget.removeEventListener("scroll",this.viewportHandler)),this.viewportTarget=null,this.viewportHandler=null,this.modalEl.style.removeProperty("--folder-summary-chat-vh"),this.modalEl.removeClass("folder-summary-chat-modal"),this.modalEl.removeClass("folder-summary-chat-modal--glass"),this.modalEl.removeClass("folder-summary-chat-modal--quiet"),this.contentEl.removeClass("folder-summary-chat--glass"),this.contentEl.removeClass("folder-summary-chat--quiet"),this.contentEl.empty()}appendMessage(t,e,s){let a=t.createEl("div");a.addClass("folder-summary-chat__message"),a.addClass(e==="user"?"folder-summary-chat__message--user":"folder-summary-chat__message--assistant"),a.createEl("div",{text:e==="user"?"\u0412\u044B":"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let i=a.createEl("div");if(i.addClass("folder-summary-chat__message-body"),e==="assistant"){this.renderAssistantMarkdown(i,s);let r=a.createEl("div");r.addClass("folder-summary-chat__message-actions");let o=r.createEl("button",{text:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C"});o.addClass("folder-summary-chat__message-save"),o.onclick=()=>void this.onSave(s)}else i.setText(s)}appendLoadingMessage(t){let e=t.createEl("div");e.addClass("folder-summary-chat__message"),e.addClass("folder-summary-chat__message--assistant"),e.addClass("folder-summary-chat__message--loading"),e.createEl("div",{text:"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let a=e.createEl("div");a.addClass("folder-summary-chat__message-body");let n=a.createEl("span");n.addClass("folder-summary-chat__loading-dots");for(let i=0;i<3;i+=1){let r=n.createEl("span",{text:"."});r.addClass("folder-summary-chat__loading-dot"),r.setAttr("aria-hidden","true")}return{wrapper:e,body:a}}updateStreamingMessage(t,e){t.addClass("folder-summary-chat__message-body--streaming"),this.updateTypingText(t,e)}finalizeStreamingMessage(t,e){this.queueFinalize(t,e)}renderAssistantMarkdown(t,e){t.empty(),c.MarkdownRenderer.render(this.app,e,t,this.markdownSourcePath,this.markdownComponent)}updateTypingText(t,e){this.streamingRenderTarget!==t&&(this.streamingRenderTarget=t,this.streamingTypingProgress=0),this.streamingRenderText=e,this.streamingTypingTimer===null&&(this.streamingTypingTimer=window.setInterval(()=>this.tickStreamingTyping(),mt))}stopStreamingTyping(){this.streamingTypingTimer!==null&&(window.clearInterval(this.streamingTypingTimer),this.streamingTypingTimer=null),this.streamingTypingProgress=0}tickStreamingTyping(){if(!this.streamingRenderTarget){this.stopStreamingTyping();return}let t=this.streamingRenderText;if(!t){this.stopStreamingTyping();return}let e=t.length-this.streamingTypingProgress;if(e<=0){if(this.streamingFinalizeTarget){let n=this.streamingFinalizeTarget;this.streamingFinalizeTarget=null,this.completeFinalize(n.body,n.text)}else this.stopStreamingTyping();return}let s=Math.ceil(e/pt),a=Math.max(dt,s);this.streamingTypingProgress=Math.min(t.length,this.streamingTypingProgress+a),this.streamingRenderTarget.setText(t.slice(0,this.streamingTypingProgress))}queueFinalize(t,e){this.streamingFinalizeTarget={body:t,text:e},this.streamingTypingTimer===null&&this.completeFinalize(t,e)}completeFinalize(t,e){this.stopStreamingTyping(),t.removeClass("folder-summary-chat__message-body--streaming"),this.renderAssistantMarkdown(t,e)}resetStreamingState(){this.stopStreamingTyping(),this.streamingRenderText="",this.streamingRenderTarget=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null}renderArtifactStatus(t,e){let s=new Map;t.createEl("div",{text:"\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B"}).addClass("folder-summary-chat__artifact-title");let n=t.createEl("ul");n.addClass("folder-summary-chat__artifact-list");for(let i of e){let r=this.extractFilename(i),o=this.isArtifactDownloaded(i),l=n.createEl("li");l.addClass("folder-summary-chat__artifact-item");let h=l.createEl("a",{text:r});h.href="#",h.onclick=g=>{if(g.preventDefault(),h.classList.contains("folder-summary-chat__artifact-open--disabled")){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}this.openArtifact(i)},h.addClass("folder-summary-chat__artifact-name"),h.addClass("folder-summary-chat__artifact-open"),o||h.addClass("folder-summary-chat__artifact-open--disabled");let u=l.createEl("span",{text:o?"\u0433\u043E\u0442\u043E\u0432\u043E":"\u043E\u0436\u0438\u0434\u0430\u043D\u0438\u0435"});u.addClass("folder-summary-chat__artifact-status"),s.set(i,{status:u,open:h})}return s}getArtifactLocalPath(t){return`${this.markdownSourcePath?`${this.markdownSourcePath}/`:""}${K}/${J}/${this.extractFilename(t)}`}isArtifactDownloaded(t){return this.app.vault.getAbstractFileByPath(this.getArtifactLocalPath(t))instanceof c.TFile}async openArtifact(t){let e=this.getArtifactLocalPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile)){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}await this.app.workspace.getLeaf(!0).openFile(s)}extractFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}},N=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new c.Setting(t).setName("API host").setDesc("Host URL for the future summary/chat API.").addText(e=>e.setPlaceholder("https://api.example.com").setValue(this.plugin.settings.apiHost).onChange(async s=>{this.plugin.settings.apiHost=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("API key").setDesc("API key used for authentication.").addText(e=>e.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary endpoint path").setDesc("Path for summary API (relative to host).").addText(e=>e.setPlaceholder("/summaries").setValue(this.plugin.settings.apiSummaryPath).onChange(async s=>{this.plugin.settings.apiSummaryPath=s.trim()||"/summaries",await this.plugin.saveSettings()})),new c.Setting(t).setName("Transcription endpoint path").setDesc("Path for audio transcription API (relative to host).").addText(e=>e.setPlaceholder("/transcriptions").setValue(this.plugin.settings.apiTranscriptionPath).onChange(async s=>{this.plugin.settings.apiTranscriptionPath=s.trim()||"/transcriptions",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat endpoint path").setDesc("Path for chat API (relative to host).").addText(e=>e.setPlaceholder("/chat").setValue(this.plugin.settings.apiChatPath).onChange(async s=>{this.plugin.settings.apiChatPath=s.trim()||"/chat",await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary file name").setDesc("File name for the summary saved in the folder.").addText(e=>e.setPlaceholder("_summary.md").setValue(this.plugin.settings.summaryFileName).onChange(async s=>{this.plugin.settings.summaryFileName=s.trim()||"_summary.md",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat theme").setDesc("Visual style for the chat modal.").addDropdown(e=>e.addOption("glass","iOS Glass").addOption("quiet","iOS Calm").addOption("classic","iOS Classic").setValue(this.plugin.settings.chatTheme).onChange(async s=>{this.plugin.settings.chatTheme=s==="classic"||s==="quiet"?s:"glass",await this.plugin.saveSettings()}))}},O=class extends c.Modal{constructor(){super(...arguments);this.statusEl=null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("devbrief-progress"),e.createEl("div").addClass("devbrief-progress__spinner");let a=e.createEl("div",{text:"..."});a.addClass("devbrief-progress__status"),this.statusEl=a}setStatus(e){this.statusEl&&this.statusEl.setText(e)}onClose(){this.contentEl.empty(),this.statusEl=null}},z=class extends c.Modal{constructor(t,e){super(t),this.message=e}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("devbrief-error"),t.createEl("h3",{text:"\u041E\u0448\u0438\u0431\u043A\u0430"}),t.createEl("p",{text:"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0449\u0435\u043D\u0438\u0438 \u043A API."}),t.createEl("pre",{text:this.message})}onClose(){this.contentEl.empty()}};function V(y){let t="",e=new Uint8Array(y),s=8192;for(let a=0;a<e.length;a+=s){let n=e.subarray(a,a+s);t+=String.fromCharCode(...n)}return btoa(t)}
