"use strict";var L=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var G=(y,t)=>{for(var e in t)L(y,e,{get:t[e],enumerable:!0})},Y=(y,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of J(t))!V.call(y,a)&&a!==e&&L(y,a,{get:()=>t[a],enumerable:!(s=K(t,a))||s.enumerable});return y};var X=y=>Y(L({},"__esModule",{value:!0}),y);var ut={};G(ut,{default:()=>E});module.exports=X(ut);var c=require("obsidian"),Q={apiHost:"",apiKey:"",apiSummaryPath:"/summaries",apiTranscriptionPath:"/transcriptions",apiChatPath:"/chat",summaryFileName:"_summary.md",chatTheme:"quiet"},Z="You are a helpful assistant. Use the provided folder summary as context.",tt=new Set(["mp3","wav","m4a","ogg","flac","opus"]),et=new Set(["png","jpg","jpeg","gif","webp"]),st=new Set(["mp3","wav","m4a","aac","ogg","flac","opus","webm"]),at=10*1024*1024,W="4senseContext",U="artefacts",H="chat-",it="chat-state.json",D="snapshot.json",nt=120,rt=Math.max(24,Math.floor(nt/4)),ot=2,lt=20,z="websocket",ct="True",ht=8e3,E=class extends c.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new R(this.app,this)),this.addCommand({id:"summarize-folder-select",name:"Summarize folder (select)",callback:()=>this.openFolderSelectModal(t=>this.summarizeFolder(t))}),this.addCommand({id:"summarize-current-folder",name:"Summarize current file folder",callback:()=>this.summarizeCurrentFileFolder()}),this.app.workspace.onLayoutReady(()=>this.registerUiActions())}onunload(){}async summarizeCurrentFileFolder(){let t=this.getCurrentFileFolder();if(!t){new c.Notice("No active file to determine folder.");return}await this.summarizeFolder(t)}getCurrentFileFolder(){let t=this.app.workspace.getActiveFile();if(!t)return null;let e=t.parent;return e instanceof c.TFolder?e:null}openFolderSelectModal(t){new M(this.app,t).open()}registerUiActions(){this.addRibbonIcon("sparkles","Chat with assistant",()=>{this.openFolderSelectModal(e=>this.openChatForFolder(e))}),this.registerEvent(this.app.workspace.on("file-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(i=>i.setTitle("4Sense: Chat with assistant").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}));let t=this.app.workspace;this.registerEvent(t.on("file-explorer-context-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(i=>i.setTitle("4Sense: Chat with assistant").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}))}resolveFolderFromAbstractFile(t){return t?t instanceof c.TFolder?t:t instanceof c.TFile&&t.parent instanceof c.TFolder?t.parent:null:null}async summarizeFolder(t,e){let s=new I(this.app);s.open();try{s.setStatus("\u0421\u043A\u0430\u043D\u0438\u0440\u0443\u044E \u0444\u0430\u0439\u043B\u044B...");let a=e??this.collectFilesInFolder(t),{textFiles:i,audioFiles:n,imageFiles:o,unsupportedAudioFiles:r,skippedFiles:l}=this.splitFiles(a);if(i.length===0&&n.length===0&&o.length===0){new c.Notice("No supported files found in the selected folder.");return}if(r.length>0){let p=r.map(f=>f.name).slice(0,3).join(", "),g=r.length>3?` (+${r.length-3} more)`:"";new c.Notice(`Unsupported audio formats: ${p}${g}`)}l.length>0&&new c.Notice(`Skipping ${l.length} unsupported files.`),s.setStatus("\u0413\u043E\u0442\u043E\u0432\u043B\u044E \u0434\u0430\u043D\u043D\u044B\u0435...");let u=await this.buildSummaryPayload(t,a,n.length,o,p=>s.setStatus(p));s.setStatus("\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u044E \u0434\u0430\u043D\u043D\u044B\u0435 \u043D\u0430 \u0441\u0443\u043C\u043C\u0430\u0440\u0438\u0437\u0430\u0446\u0438\u044E...");let d=await this.callSummaryApi(u);s.setStatus("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u044E \u0441\u0430\u043C\u043C\u0430\u0440\u0438..."),await this.writeSummaryFile(t,d),await this.writeSnapshot(t,a),new c.Notice("Summary saved.")}catch(a){this.showErrorModal(a)}finally{s.close()}}collectFilesInFolder(t){let e=this.getContextPath(t),s=this.getArtifactsPath(t),a=`${e}/${this.settings.summaryFileName}`,i=[],n=o=>{for(let r of o.children){if(r instanceof c.TFolder){if(r.path===e||r.path.startsWith(`${e}-`)||r.path===s||r.path.startsWith(`${s}/`))continue;n(r);continue}r instanceof c.TFile&&(r.path===a||r.path.startsWith(`${e}/`)||r.path.startsWith(`${e}-`)||r.path.startsWith(`${s}/`)||i.push(r))}};return n(t),i.sort((o,r)=>o.stat.ctime-r.stat.ctime),i}async buildSummaryPayload(t,e,s,a,i){let n=[],o=new Set(a.map(l=>l.path)),r=0;for(let l of e){if(this.isMarkdownFile(l)){let u=await this.app.vault.read(l);n.push({path:l.path,kind:this.isExcalidrawFile(l)?"excalidraw":"markdown",content:u});continue}if(o.has(l.path)){if(l.stat.size>at){i&&i(`\u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u044E \u0431\u043E\u043B\u044C\u0448\u043E\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);continue}i&&i(`\u0414\u043E\u0431\u0430\u0432\u043B\u044F\u044E \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);let d=B(await this.app.vault.readBinary(l));n.push({path:l.path,kind:"image",content:d});continue}if(this.isSupportedAudioFile(l)){r+=1,i&&i(`\u0422\u0440\u0430\u043D\u0441\u043A\u0440\u0438\u0431\u0438\u0440\u0443\u044E \u0430\u0443\u0434\u0438\u043E ${r}/${s}: ${l.name}`);let u=await this.callTranscriptionApi(l);if(!u)continue;n.push({path:l.path,kind:"audio_transcript",content:u})}}return{folderPath:t.path,files:n}}async callSummaryApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in plugin settings.");let e=this.buildApiUrl(this.settings.apiSummaryPath),s={"Content-Type":"application/json"};this.settings.apiKey&&(s.Authorization=`Bearer ${this.settings.apiKey}`);let a=await this.requestJson(e,s,t);if(typeof a=="object"&&a!==null&&typeof a.summary=="string")return a.summary;throw new Error("Summary API returned an unexpected response.")}async writeSummaryFile(t,e){await this.ensureContextFolder(t);let s=this.getSummaryFilePath(t);await this.replaceTextFile(s,e)}async replaceTextFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s instanceof c.TFile){await this.app.vault.process(s,()=>e);return}await this.app.vault.create(t,e)}async appendTextFile(t,e,s=""){let a=this.app.vault.getAbstractFileByPath(t);if(a instanceof c.TFile){await this.app.vault.process(a,i=>i+e);return}await this.app.vault.create(t,`${s}${e}`)}async openChatForFolder(t){try{let e=this.collectFilesInFolder(t),s=await this.getSnapshotState(t,e);s.changed?(await this.archiveContextFolder(t),await this.ensureContextFolder(t),await this.writeSnapshot(t,e)):s.exists||(await this.ensureContextFolder(t),await this.writeSnapshot(t,e)),await this.ensureContextFolder(t),await this.ensureArtifactsFolder(t);let a=await this.readSummaryFile(t);if(a||(await this.summarizeFolder(t,e),a=await this.readSummaryFile(t)),!a){new c.Notice("Summary file not found. Unable to open chat.");return}let i=await this.getOrCreateChatLog(t),n=await this.loadChatHistory(i);if(n.length===0){let r=await this.findChatHistory(t,i,!0);r&&(n=this.stripTimestamps(r.entries),await this.writeChatLog(i,r.entries))}new $(this.app,this,a,t.name||t.path||"",t.path??"",this.settings.chatTheme,n,async(r,l,u,d)=>this.callChatApiStream(l,r,u,d),async r=>this.saveAssistantResponse(t,r),async(r,l)=>this.appendChatLog(i,r,l),async(r,l)=>this.downloadArtifacts(t,r,l)).open()}catch(e){this.showErrorModal(e)}}async readSummaryFile(t){let e=this.getSummaryFilePath(t),s=this.app.vault.getAbstractFileByPath(e);return s instanceof c.TFile?this.app.vault.read(s):null}async callChatApi(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let a=this.buildApiUrl(this.settings.apiChatPath),i={"Content-Type":"application/json"};this.settings.apiKey&&(i.Authorization=`Bearer ${this.settings.apiKey}`);let n=await this.requestJson(a,i,{summary:t,messages:this.stripTimestamps(e)},s),o=typeof n=="object"&&n!==null?n.message??n.response??n.content:void 0;if(typeof o=="string")return{message:o,artifactPaths:this.extractArtifactPaths(o)};throw new Error("Chat API returned an unexpected response.")}async callChatApiStream(t,e,s,a){try{return await this.callChatApiWebSocket(t,e,s,a)}catch(i){if(this.isAbortError(i))throw i;let n=await this.callChatApi(t,e,a);return n.message.length>0&&s(n.message),n}}async callChatApiWebSocket(t,e,s,a){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");if(typeof WebSocket!="function")throw new Error("WebSocket is not available in this environment.");let i=this.buildChatWebSocketUrl(),n=JSON.stringify({summary:t,messages:this.stripTimestamps(e),apiKey:this.settings.apiKey||void 0});return new Promise((o,r)=>{let l=!1,u="",d=new WebSocket(i),p=()=>{d.onopen=null,d.onmessage=null,d.onerror=null,d.onclose=null,a&&a.removeEventListener("abort",x),window.clearTimeout(S)},g=h=>{l||(l=!0,p(),o(h))},f=h=>{l||(l=!0,p(),r(h))},w=h=>{g({message:h,artifactPaths:this.extractArtifactPaths(h)})},x=()=>{try{d.close(1e3,"aborted")}catch{}f(new Error("Request aborted"))},C=h=>{if(typeof h=="string"){let v=h.trim();if(v==="[DONE]"||v==="__DONE__"){w(u);try{d.close(1e3,"done")}catch{}return}u+=h,s(h);return}if(!h||typeof h!="object")return;let m=h;if(m.type==="error"){let v=typeof m.message=="string"?m.message:typeof m.error=="string"?m.error:"Chat websocket error.";throw new Error(v)}if(m.type==="chunk"){let v=typeof m.text=="string"?m.text:"";v.length>0&&(u+=v,s(v));return}if(m.type==="done"||m.done===!0){w(u);try{d.close(1e3,"done")}catch{}return}let P=typeof m.message=="string"?m.message:typeof m.response=="string"?m.response:typeof m.content=="string"?m.content:typeof m.text=="string"?m.text:null;P!==null&&(u+=P,s(P))},S=window.setTimeout(()=>{try{d.close()}catch{}f(new Error("WebSocket connection timed out."))},ht);if(a){if(a.aborted){x();return}a.addEventListener("abort",x,{once:!0})}d.onopen=()=>{window.clearTimeout(S),d.send(n)},d.onmessage=h=>{if(!l)try{if(typeof h.data=="string"){let m=h.data;try{C(JSON.parse(m))}catch{C(m)}return}if(h.data instanceof ArrayBuffer){let m=new TextDecoder().decode(h.data);try{C(JSON.parse(m))}catch{C(m)}return}C(String(h.data??""))}catch(m){f(m instanceof Error?m:new Error("Failed to process websocket frame."))}},d.onerror=()=>{f(new Error("WebSocket connection failed."))},d.onclose=h=>{if(!l){if(h.code===1e3){w(u);return}if(u.length>0){w(u);return}f(new Error(`WebSocket closed with code ${h.code}.`))}}})}async callTranscriptionApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let e=this.buildApiUrl(this.settings.apiTranscriptionPath),s=await this.app.vault.readBinary(t),a=this.getAudioContentType(t),i={path:t.path,name:t.name,data:B(s),contentType:a},n={"Content-Type":"application/json"};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`),n["X-Audio-Content-Type"]=a;let o=await this.requestJson(e,n,i),r=typeof o=="object"&&o!==null?o.text??o.transcript??o.transcription??null:null;if(typeof r=="string"&&r.length>0)return r;throw new Error("Transcription API returned an unexpected response.")}async loadSettings(){this.settings=Object.assign({},Q,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}buildApiUrl(t){let e=this.settings.apiHost.trim(),s=e.endsWith("/")?e:`${e}/`,a=t.trim().replace(/^\/+/u,"");return new URL(a,s).toString()}buildChatWebSocketUrl(){let t=this.buildApiUrl(this.settings.apiChatPath),e=new URL(t);return e.protocol=e.protocol==="https:"?"wss:":"ws:",e.searchParams.has(z)||e.searchParams.set(z,ct),e.toString()}getContextPath(t){return`${t.path?`${t.path}/`:""}${W}`}getArtifactsPath(t){return`${this.getContextPath(t)}/${U}`}getSummaryFilePath(t){return`${this.getContextPath(t)}/${this.settings.summaryFileName}`}async ensureFolderExists(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFolder)){if(e)throw new Error(`Path exists but is not a folder: ${t}`);await this.app.vault.createFolder(t)}}async ensureContextFolder(t){await this.ensureFolderExists(this.getContextPath(t))}async ensureArtifactsFolder(t){await this.ensureFolderExists(this.getArtifactsPath(t))}async requestJson(t,e,s,a){let i=await(0,c.requestUrl)({url:t,method:"POST",headers:e,body:JSON.stringify(s)});if(i.status<200||i.status>=300){let n=this.extractErrorDetail(i);throw new Error(n??`API error: ${i.status}`)}if(i.json)return i.json;try{return JSON.parse(i.text)}catch{throw new Error("API returned non-JSON response.")}}extractErrorDetail(t){let e=typeof t.json=="object"&&t.json!==null?t.json:null,s=e?.detail??e?.message;return typeof s=="string"&&s.trim().length>0?s.trim():t.text&&t.text.trim().length>0?t.text.trim():null}showErrorModal(t){let e=t instanceof Error?t.message:typeof t=="string"?t:"Unknown error.";new N(this.app,e).open()}isAbortError(t){return t instanceof Error?t.message.toLowerCase().includes("abort"):!1}async getSnapshotState(t,e){let s=await this.readSnapshot(t);if(!s)return{exists:!1,changed:!1};let a=new Map(e.map(i=>[i.path,i.stat.mtime]));if(s.files.length!==a.size)return{exists:!0,changed:!0};for(let i of s.files){let n=a.get(i.path);if(n===void 0||n!==i.mtime)return{exists:!0,changed:!0}}return{exists:!0,changed:!1}}async readSnapshot(t){let e=`${this.getContextPath(t)}/${D}`,s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s);return JSON.parse(a)}catch{return null}}async writeSnapshot(t,e){await this.ensureContextFolder(t);let s={files:e.map(n=>({path:n.path,mtime:n.stat.mtime}))},a=`${this.getContextPath(t)}/${D}`,i=JSON.stringify(s,null,2);await this.replaceTextFile(a,i)}async archiveContextFolder(t){let e=this.getContextPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFolder))return;let a=`${e}-${this.formatTimestamp(new Date)}`;await this.app.vault.rename(s,a)}async getOrCreateChatLog(t){await this.ensureContextFolder(t);let e=await this.readChatState(t);if(e?.activeLogPath){let n=this.app.vault.getAbstractFileByPath(e.activeLogPath);if(n instanceof c.TFile&&n.extension==="md")return e.activeLogPath}let s=this.getLatestChatLogPath(t);if(s)return await this.writeChatState(t,s),s;let a=`${H}${this.formatTimestamp(new Date)}.md`,i=`${this.getContextPath(t)}/${a}`;return await this.app.vault.create(i,`# Chat history

`),await this.writeChatState(t,i),i}getLatestChatLogPath(t){let e=this.getChatLogCandidates(t);return e.length===0?null:(e.sort((s,a)=>a.stat.mtime-s.stat.mtime),e[0].path)}getChatLogCandidates(t,e=!1){let s=this.getContextPath(t),a=[],i=r=>e?r.extension==="md"||r.extension==="json":r.extension==="md",n=r=>{for(let l of r.children){if(l instanceof c.TFolder){n(l);continue}l instanceof c.TFile&&l.name.startsWith(H)&&i(l)&&a.push(l)}},o=t.children.filter(r=>r instanceof c.TFolder&&(r.path===s||r.path.startsWith(`${s}-`)));for(let r of o)n(r);return a}async findChatHistory(t,e,s){let a=this.getChatLogCandidates(t,s);if(a.length===0)return null;a.sort((i,n)=>n.stat.mtime-i.stat.mtime);for(let i of a){if(i.path===e)continue;let n=await this.loadChatEntries(i.path);if(n.length>0)return{path:i.path,entries:n}}return null}async loadChatHistory(t){let e=await this.loadChatEntries(t);return this.stripTimestamps(e)}async loadChatEntries(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFile))return[];let s=await this.app.vault.read(e);return this.parseChatLog(s)}parseChatLog(t){let e=t.trim();if(e.startsWith("{")||e.startsWith("["))try{let l=JSON.parse(e),u=Array.isArray(l)?l:l.messages??l.history??l.items??l.log??[];return(Array.isArray(u)?u:[]).map(p=>{if(!p||typeof p!="object")return null;let g=p,f=g.role??g.type??g.author??g.sender??null;if(f!=="user"&&f!=="assistant"&&f!=="system")return null;let w=g.content??g.text??g.message??"";return typeof w!="string"?null:{role:f,content:w,timestamp:this.extractTimestamp(g)}}).filter(p=>!!p)}catch{}let s=[],a=t.split(/\r?\n/),i=null,n,o=[],r=()=>{if(i&&o.length>0){let l=o.join(`
`).trim();l.length>0&&s.push({role:i,content:l,timestamp:n})}};for(let l of a){let u=l.match(/^## \[(.+)\] (user|assistant)$/u);if(u){r(),i=u[2],n=u[1],o=[];continue}l.startsWith("# Chat history")||o.push(l)}return r(),s}async appendChatLog(t,e,s){let i=`## [${new Date().toISOString()}] ${e}
${s}

`;await this.appendTextFile(t,i,`# Chat history

`)}async writeChatLog(t,e){let s=`# Chat history

`,a=e.filter(n=>n.role==="user"||n.role==="assistant").map(n=>`## [${n.timestamp??new Date().toISOString()}] ${n.role}
${n.content}

`).join(""),i=s+a;await this.replaceTextFile(t,i)}stripTimestamps(t){return t.map(e=>({role:e.role,content:e.content}))}extractTimestamp(t){let e=t.timestamp??t.time??t.created_at??t.createdAt??t.date??t.ts??null;return this.normalizeTimestamp(e)??void 0}normalizeTimestamp(t){if(typeof t=="string"){let e=new Date(t);return Number.isNaN(e.getTime())?null:e.toISOString()}if(typeof t=="number"&&Number.isFinite(t)){let e=t<1e12?t*1e3:t,s=new Date(e);if(!Number.isNaN(s.getTime()))return s.toISOString()}return null}getChatStatePath(t){return`${this.getContextPath(t)}/${it}`}async readChatState(t){let e=this.getChatStatePath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s);return JSON.parse(a)}catch{return null}}async writeChatState(t,e){await this.ensureContextFolder(t);let s=this.getChatStatePath(t),a=JSON.stringify({activeLogPath:e},null,2);await this.replaceTextFile(s,a)}extractArtifactPaths(t){let e=t.split(/\r?\n/),s=[],a=!1;for(let i of e){let n=i.trim();if(n.startsWith("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B:")){a=!0;continue}if(!a)continue;let o=n.match(/^-\s*(\/artifacts\/\S+)/u);if(o){s.push(o[1]);continue}if(n.length>0)break}return s}async downloadArtifacts(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");await this.ensureArtifactsFolder(t);for(let a of e){s(a,"\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430");try{let i=this.buildApiUrl(a),n={};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`);let o=await(0,c.requestUrl)({url:i,method:"GET",headers:n});if(o.status<200||o.status>=300)throw new Error(`Artifact download failed: ${o.status}`);let r=o.arrayBuffer??new TextEncoder().encode(o.text??"").buffer,l=this.getArtifactFilename(a),u=`${this.getArtifactsPath(t)}/${l}`,d=this.app.vault.getAbstractFileByPath(u);d instanceof c.TFile?await this.app.vault.modifyBinary(d,r):await this.app.vault.createBinary(u,r),s(a,"\u0433\u043E\u0442\u043E\u0432\u043E")}catch{s(a,"\u043E\u0448\u0438\u0431\u043A\u0430")}}}getArtifactFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}splitFiles(t){let e=[],s=[],a=[],i=[],n=[];for(let o of t){if(this.isSupportedAudioFile(o)){s.push(o);continue}if(this.isImageFile(o)){a.push(o);continue}if(this.isAnyAudioFile(o)){i.push(o);continue}if(this.isMarkdownFile(o)){e.push(o);continue}n.push(o)}return{textFiles:e,audioFiles:s,imageFiles:a,unsupportedAudioFiles:i,skippedFiles:n}}isMarkdownFile(t){return t.extension==="md"}isExcalidrawFile(t){return t.path.endsWith(".excalidraw.md")}isSupportedAudioFile(t){return tt.has(t.extension.toLowerCase())}isAnyAudioFile(t){return st.has(t.extension.toLowerCase())}isImageFile(t){return et.has(t.extension.toLowerCase())}getAudioContentType(t){let e=t.extension.toLowerCase();switch(e){case"mp3":case"m4a":return"audio/mpeg";case"ogg":case"opus":return"audio/ogg;codecs=opus";case"flac":return"audio/flac";case"wav":return"audio/x-pcm;bit=16;rate=16000";default:throw new Error(`Unsupported audio format: .${e}`)}}async saveAssistantResponse(t,e){await this.ensureContextFolder(t);let s=`${this.getContextPath(t)}/`,a=this.formatTimestamp(new Date),i=`ai-response-${a}.md`,n=`${s}${i}`,o=1;for(;this.app.vault.getAbstractFileByPath(n);)n=`${s}ai-response-${a}-${o}.md`,o+=1;await this.app.vault.create(n,e),new c.Notice(`Saved response to ${n}`)}formatTimestamp(t){let e=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getFullYear()).slice(-2),i=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0");return`${e}-${s}-${a}T${i}-${n}-${o}`}},M=class extends c.FuzzySuggestModal{constructor(t,e){super(t),this.onSelect=e,this.folders=this.collectFolders(),this.setPlaceholder("Select a folder to summarize")}getItems(){return this.folders}getItemText(t){return t.path||"/"}onChooseItem(t){this.onSelect(t)}collectFolders(){let t=this.app.vault.getAllLoadedFiles(),e=[];for(let s of t)s instanceof c.TFolder&&e.push(s);return e}},$=class extends c.Modal{constructor(t,e,s,a,i,n,o,r,l,u,d){super(t),this.markdownComponent=e,this.summary=s,this.folderLabel=a,this.theme=n,this.useSummary=!0,this.markdownSourcePath=i,this.onStream=r,this.onSave=l,this.onLog=u,this.onDownloadArtifacts=d,this.messages=[{role:"system",content:Z},...o],this.isWaiting=!1,this.requestCounter=0,this.canceledRequest=null,this.currentAbort=null,this.streamingRenderTarget=null,this.streamingRenderText="",this.streamingTypingTimer=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null}onOpen(){let{contentEl:t}=this;t.empty(),this.modalEl.addClass("folder-summary-chat-modal"),t.addClass("folder-summary-chat"),this.theme==="glass"&&(this.modalEl.addClass("folder-summary-chat-modal--glass"),t.addClass("folder-summary-chat--glass")),this.theme==="quiet"&&(this.modalEl.addClass("folder-summary-chat-modal--quiet"),t.addClass("folder-summary-chat--quiet")),t.createEl("h3",{text:"Chat with assistant"}).addClass("folder-summary-chat__title");let s=t.createEl("div");s.addClass("folder-summary-chat__output");for(let h of this.messages)(h.role==="user"||h.role==="assistant")&&this.appendMessage(s,h.role,h.content);let a=t.createEl("textarea");a.addClass("folder-summary-chat__input"),a.placeholder="Ask a question...";let i=t.createEl("button",{text:"Send"});i.addClass("folder-summary-chat__send");let n=h=>{this.isWaiting=h,a.disabled=h,h?(i.setText("Stop"),i.addClass("folder-summary-chat__send--stop")):(i.setText("Send"),i.removeClass("folder-summary-chat__send--stop"))},o=async()=>{let h=a.value.trim();if(!h||this.isWaiting)return;a.value="",this.appendMessage(s,"user",h),this.messages.push({role:"user",content:h}),await this.onLog("user",h),this.resetStreamingState();let m=this.appendLoadingMessage(s);s.scrollTop=s.scrollHeight,n(!0);let P=++this.requestCounter,v=new AbortController;this.currentAbort=v;let A="",b=!1,_=()=>{b||(b=!0,m.wrapper.removeClass("folder-summary-chat__message--loading"),m.body.empty(),m.body.addClass("folder-summary-chat__message-body--streaming"))};try{let F=await this.onStream(this.messages,this.useSummary?this.summary:"",T=>{_(),A+=T,this.updateStreamingMessage(m.body,A),s.scrollTop=s.scrollHeight},v.signal);if(this.canceledRequest===P)m.wrapper.remove();else{b||_();let T=F.message||A;if(this.messages.push({role:"assistant",content:T}),this.finalizeStreamingMessage(m.body,T),await this.onLog("assistant",T),F.artifactPaths.length>0){let q=this.renderArtifactStatus(m.wrapper,F.artifactPaths);this.onDownloadArtifacts(F.artifactPaths,(j,O)=>{let k=q.get(j);k&&(k.status.setText(O),k.open.classList.toggle("folder-summary-chat__artifact-open--disabled",O!=="\u0433\u043E\u0442\u043E\u0432\u043E"))})}}}catch(F){if(this.canceledRequest!==P){let T=F instanceof Error?F.message:"Failed to fetch response.";T.toLowerCase().includes("abort")?m.wrapper.remove():(_(),this.updateStreamingMessage(m.body,T))}else m.wrapper.remove()}finally{n(!1),this.canceledRequest=null,this.currentAbort=null}s.scrollTop=s.scrollHeight};i.onclick=()=>{if(this.isWaiting){this.canceledRequest=this.requestCounter,this.currentAbort?.abort(),n(!1);return}o()},a.addEventListener("keydown",h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),o())});let r=t.createEl("div");r.addClass("folder-summary-chat__actions"),r.appendChild(i);let l=r.createEl("button",{text:"Summary"});l.addClass("folder-summary-chat__summary-open");let u=r.createEl("label");u.addClass("folder-summary-chat__summary-toggle");let d=u.createEl("input");d.type="checkbox",d.checked=!0,d.addClass("folder-summary-chat__summary-checkbox"),u.createEl("span").addClass("folder-summary-chat__summary-slider"),u.createEl("span",{text:"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C summary \u0432 \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442"}),d.addEventListener("change",()=>{this.useSummary=d.checked});let p=t.createEl("div");p.addClass("folder-summary-chat__summary-sheet"),p.addClass("folder-summary-chat__summary-sheet--hidden"),p.setAttr("aria-hidden","true");let g=p.createEl("div");g.addClass("folder-summary-chat__summary-panel");let f=g.createEl("div");f.addClass("folder-summary-chat__summary-header"),f.createEl("div",{text:`Summary: ${this.folderLabel}`}).addClass("folder-summary-chat__summary-header-title");let w=f.createEl("button",{text:"Close"});w.addClass("folder-summary-chat__summary-close"),g.createEl("pre",{text:this.summary}).addClass("folder-summary-chat__summary-text");let C=()=>{p.removeClass("folder-summary-chat__summary-sheet--hidden"),p.setAttr("aria-hidden","false"),w.focus()},S=()=>{p.addClass("folder-summary-chat__summary-sheet--hidden"),p.setAttr("aria-hidden","true")};l.onclick=()=>C(),w.onclick=()=>S(),p.addEventListener("click",h=>{h.target===p&&S()}),t.addEventListener("keydown",h=>{h.key==="Escape"&&!p.classList.contains("folder-summary-chat__summary-sheet--hidden")&&(h.preventDefault(),S())})}onClose(){this.currentAbort?.abort(),this.currentAbort=null,this.resetStreamingState(),this.modalEl.removeClass("folder-summary-chat-modal"),this.modalEl.removeClass("folder-summary-chat-modal--glass"),this.modalEl.removeClass("folder-summary-chat-modal--quiet"),this.contentEl.removeClass("folder-summary-chat--glass"),this.contentEl.removeClass("folder-summary-chat--quiet"),this.contentEl.empty()}appendMessage(t,e,s){let a=t.createEl("div");a.addClass("folder-summary-chat__message"),a.addClass(e==="user"?"folder-summary-chat__message--user":"folder-summary-chat__message--assistant"),a.createEl("div",{text:e==="user"?"\u0412\u044B":"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let n=a.createEl("div");if(n.addClass("folder-summary-chat__message-body"),e==="assistant"){this.renderAssistantMarkdown(n,s);let o=a.createEl("div");o.addClass("folder-summary-chat__message-actions");let r=o.createEl("button",{text:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C"});r.addClass("folder-summary-chat__message-save"),r.onclick=()=>void this.onSave(s)}else n.setText(s)}appendLoadingMessage(t){let e=t.createEl("div");e.addClass("folder-summary-chat__message"),e.addClass("folder-summary-chat__message--assistant"),e.addClass("folder-summary-chat__message--loading"),e.createEl("div",{text:"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let a=e.createEl("div");a.addClass("folder-summary-chat__message-body");let i=a.createEl("span");i.addClass("folder-summary-chat__loading-dots");for(let n=0;n<3;n+=1){let o=i.createEl("span",{text:"."});o.addClass("folder-summary-chat__loading-dot"),o.setAttr("aria-hidden","true")}return{wrapper:e,body:a}}updateStreamingMessage(t,e){t.addClass("folder-summary-chat__message-body--streaming"),this.updateTypingText(t,e)}finalizeStreamingMessage(t,e){this.queueFinalize(t,e)}renderAssistantMarkdown(t,e){t.empty(),c.MarkdownRenderer.render(this.app,e,t,this.markdownSourcePath,this.markdownComponent)}updateTypingText(t,e){this.streamingRenderTarget!==t&&(this.streamingRenderTarget=t,this.streamingTypingProgress=0),this.streamingRenderText=e,this.streamingTypingTimer===null&&(this.streamingTypingTimer=window.setInterval(()=>this.tickStreamingTyping(),rt))}stopStreamingTyping(){this.streamingTypingTimer!==null&&(window.clearInterval(this.streamingTypingTimer),this.streamingTypingTimer=null),this.streamingTypingProgress=0}tickStreamingTyping(){if(!this.streamingRenderTarget){this.stopStreamingTyping();return}let t=this.streamingRenderText;if(!t){this.stopStreamingTyping();return}let e=t.length-this.streamingTypingProgress;if(e<=0){if(this.streamingFinalizeTarget){let i=this.streamingFinalizeTarget;this.streamingFinalizeTarget=null,this.completeFinalize(i.body,i.text)}else this.stopStreamingTyping();return}let s=Math.ceil(e/lt),a=Math.max(ot,s);this.streamingTypingProgress=Math.min(t.length,this.streamingTypingProgress+a),this.streamingRenderTarget.setText(t.slice(0,this.streamingTypingProgress))}queueFinalize(t,e){this.streamingFinalizeTarget={body:t,text:e},this.streamingTypingTimer===null&&this.completeFinalize(t,e)}completeFinalize(t,e){this.stopStreamingTyping(),t.removeClass("folder-summary-chat__message-body--streaming"),this.renderAssistantMarkdown(t,e)}resetStreamingState(){this.stopStreamingTyping(),this.streamingRenderText="",this.streamingRenderTarget=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null}renderArtifactStatus(t,e){let s=new Map;t.createEl("div",{text:"\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B"}).addClass("folder-summary-chat__artifact-title");let i=t.createEl("ul");i.addClass("folder-summary-chat__artifact-list");for(let n of e){let o=this.extractFilename(n),r=this.isArtifactDownloaded(n),l=i.createEl("li");l.addClass("folder-summary-chat__artifact-item");let u=l.createEl("a",{text:o});u.href="#",u.onclick=p=>{if(p.preventDefault(),u.classList.contains("folder-summary-chat__artifact-open--disabled")){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}this.openArtifact(n)},u.addClass("folder-summary-chat__artifact-name"),u.addClass("folder-summary-chat__artifact-open"),r||u.addClass("folder-summary-chat__artifact-open--disabled");let d=l.createEl("span",{text:r?"\u0433\u043E\u0442\u043E\u0432\u043E":"\u043E\u0436\u0438\u0434\u0430\u043D\u0438\u0435"});d.addClass("folder-summary-chat__artifact-status"),s.set(n,{status:d,open:u})}return s}getArtifactLocalPath(t){return`${this.markdownSourcePath?`${this.markdownSourcePath}/`:""}${W}/${U}/${this.extractFilename(t)}`}isArtifactDownloaded(t){return this.app.vault.getAbstractFileByPath(this.getArtifactLocalPath(t))instanceof c.TFile}async openArtifact(t){let e=this.getArtifactLocalPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile)){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}await this.app.workspace.getLeaf(!0).openFile(s)}extractFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}},R=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new c.Setting(t).setName("API host").setDesc("Host URL for the future summary/chat API.").addText(e=>e.setPlaceholder("https://api.example.com").setValue(this.plugin.settings.apiHost).onChange(async s=>{this.plugin.settings.apiHost=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("API key").setDesc("API key used for authentication.").addText(e=>e.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary endpoint path").setDesc("Path for summary API (relative to host).").addText(e=>e.setPlaceholder("/summaries").setValue(this.plugin.settings.apiSummaryPath).onChange(async s=>{this.plugin.settings.apiSummaryPath=s.trim()||"/summaries",await this.plugin.saveSettings()})),new c.Setting(t).setName("Transcription endpoint path").setDesc("Path for audio transcription API (relative to host).").addText(e=>e.setPlaceholder("/transcriptions").setValue(this.plugin.settings.apiTranscriptionPath).onChange(async s=>{this.plugin.settings.apiTranscriptionPath=s.trim()||"/transcriptions",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat endpoint path").setDesc("Path for chat API (relative to host).").addText(e=>e.setPlaceholder("/chat").setValue(this.plugin.settings.apiChatPath).onChange(async s=>{this.plugin.settings.apiChatPath=s.trim()||"/chat",await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary file name").setDesc("File name for the summary saved in the folder.").addText(e=>e.setPlaceholder("_summary.md").setValue(this.plugin.settings.summaryFileName).onChange(async s=>{this.plugin.settings.summaryFileName=s.trim()||"_summary.md",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat theme").setDesc("Visual style for the chat modal.").addDropdown(e=>e.addOption("glass","iOS Glass").addOption("quiet","iOS Calm").addOption("classic","iOS Classic").setValue(this.plugin.settings.chatTheme).onChange(async s=>{this.plugin.settings.chatTheme=s==="classic"||s==="quiet"?s:"glass",await this.plugin.saveSettings()}))}},I=class extends c.Modal{constructor(){super(...arguments);this.statusEl=null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("devbrief-progress"),e.createEl("div").addClass("devbrief-progress__spinner");let a=e.createEl("div",{text:"..."});a.addClass("devbrief-progress__status"),this.statusEl=a}setStatus(e){this.statusEl&&this.statusEl.setText(e)}onClose(){this.contentEl.empty(),this.statusEl=null}},N=class extends c.Modal{constructor(t,e){super(t),this.message=e}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("devbrief-error"),t.createEl("h3",{text:"\u041E\u0448\u0438\u0431\u043A\u0430"}),t.createEl("p",{text:"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0449\u0435\u043D\u0438\u0438 \u043A API."}),t.createEl("pre",{text:this.message})}onClose(){this.contentEl.empty()}};function B(y){let t="",e=new Uint8Array(y),s=8192;for(let a=0;a<e.length;a+=s){let i=e.subarray(a,a+s);t+=String.fromCharCode(...i)}return btoa(t)}
