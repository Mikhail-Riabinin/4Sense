"use strict";var O=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var et=Object.getOwnPropertyNames;var st=Object.prototype.hasOwnProperty;var at=(w,t)=>{for(var e in t)O(w,e,{get:t[e],enumerable:!0})},it=(w,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of et(t))!st.call(w,a)&&a!==e&&O(w,a,{get:()=>t[a],enumerable:!(s=tt(t,a))||s.enumerable});return w};var nt=w=>it(O({},"__esModule",{value:!0}),w);var wt={};at(wt,{default:()=>$});module.exports=nt(wt);var c=require("obsidian"),rt={apiHost:"",apiKey:"",apiSummaryPath:"/summaries",apiTranscriptionPath:"/transcriptions",apiChatPath:"/chat",summaryFileName:"_summary.md",chatTheme:"quiet"},ot="You are a helpful assistant. Use the provided folder summary as context.",lt=new Set(["mp3","wav","m4a","ogg","flac","opus"]),ct=new Set(["png","jpg","jpeg","gif","webp"]),ht=new Set(["mp3","wav","m4a","aac","ogg","flac","opus","webm"]),ut=10*1024*1024,Y="4senseContext",G="artefacts",j="chat-",mt="chat-state.json",V="snapshot.json",pt=120,dt=Math.max(24,Math.floor(pt/4)),gt=2,ft=20,K="websocket",yt="True",vt=8e3,$=class extends c.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new z(this.app,this)),this.addCommand({id:"summarize-folder-select",name:"Summarize folder (select)",callback:()=>this.openFolderSelectModal(t=>{this.summarizeFolder(t)})}),this.addCommand({id:"summarize-current-folder",name:"Summarize current file folder",callback:()=>this.summarizeCurrentFileFolder()}),this.app.workspace.onLayoutReady(()=>this.registerUiActions())}onunload(){}async summarizeCurrentFileFolder(){let t=this.getCurrentFileFolder();if(!t){new c.Notice("No active file to determine folder.");return}await this.summarizeFolder(t)}getCurrentFileFolder(){let t=this.app.workspace.getActiveFile();if(!t)return null;let e=t.parent;return e instanceof c.TFolder?e:null}openFolderSelectModal(t){new B(this.app,t).open()}registerUiActions(){this.addRibbonIcon("sparkles","Chat with assistant 4sense",()=>{this.openFolderSelectModal(e=>{this.openChatForFolder(e)})}),this.registerEvent(this.app.workspace.on("file-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(i=>i.setTitle("Chat with assistant 4sense").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}));let t=this.app.workspace;this.registerEvent(t.on("file-explorer-context-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(i=>i.setTitle("Chat with assistant 4sense").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}))}resolveFolderFromAbstractFile(t){return t?t instanceof c.TFolder?t:t instanceof c.TFile&&t.parent instanceof c.TFolder?t.parent:null:null}async summarizeFolder(t,e){let s=new W(this.app);s.open();try{s.setStatus("\u0421\u043A\u0430\u043D\u0438\u0440\u0443\u044E \u0444\u0430\u0439\u043B\u044B...");let a=e??this.collectFilesInFolder(t),{textFiles:i,audioFiles:n,imageFiles:r,unsupportedAudioFiles:o,skippedFiles:l}=this.splitFiles(a);if(i.length===0&&n.length===0&&r.length===0){new c.Notice("No supported files found in the selected folder.");return}if(o.length>0){let g=o.map(f=>f.name).slice(0,3).join(", "),y=o.length>3?` (+${o.length-3} more)`:"";new c.Notice(`Unsupported audio formats: ${g}${y}`)}l.length>0&&new c.Notice(`Skipping ${l.length} unsupported files.`),s.setStatus("\u0413\u043E\u0442\u043E\u0432\u043B\u044E \u0434\u0430\u043D\u043D\u044B\u0435...");let h=await this.buildSummaryPayload(t,a,n.length,r,g=>s.setStatus(g));s.setStatus("\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u044E \u0434\u0430\u043D\u043D\u044B\u0435 \u043D\u0430 \u0441\u0443\u043C\u043C\u0430\u0440\u0438\u0437\u0430\u0446\u0438\u044E...");let m=await this.callSummaryApi(h);s.setStatus("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u044E \u0441\u0430\u043C\u043C\u0430\u0440\u0438..."),await this.writeSummaryFile(t,m),await this.writeSnapshot(t,a),new c.Notice("Summary saved.")}catch(a){this.showErrorModal(a)}finally{s.close()}}collectFilesInFolder(t){let e=this.getContextPath(t),s=this.getArtifactsPath(t),a=`${e}/${this.settings.summaryFileName}`,i=[],n=r=>{for(let o of r.children){if(o instanceof c.TFolder){if(o.path===e||o.path.startsWith(`${e}-`)||o.path===s||o.path.startsWith(`${s}/`))continue;n(o);continue}o instanceof c.TFile&&(o.path===a||o.path.startsWith(`${e}/`)||o.path.startsWith(`${e}-`)||o.path.startsWith(`${s}/`)||i.push(o))}};return n(t),i.sort((r,o)=>r.stat.ctime-o.stat.ctime),i}async buildSummaryPayload(t,e,s,a,i){let n=[],r=new Set(a.map(l=>l.path)),o=0;for(let l of e){if(this.isMarkdownFile(l)){let h=await this.app.vault.read(l);n.push({path:l.path,kind:this.isExcalidrawFile(l)?"excalidraw":"markdown",content:h});continue}if(r.has(l.path)){if(l.stat.size>ut){i&&i(`\u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u044E \u0431\u043E\u043B\u044C\u0448\u043E\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);continue}i&&i(`\u0414\u043E\u0431\u0430\u0432\u043B\u044F\u044E \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);let m=J(await this.app.vault.readBinary(l));n.push({path:l.path,kind:"image",content:m});continue}if(this.isSupportedAudioFile(l)){o+=1,i&&i(`\u0422\u0440\u0430\u043D\u0441\u043A\u0440\u0438\u0431\u0438\u0440\u0443\u044E \u0430\u0443\u0434\u0438\u043E ${o}/${s}: ${l.name}`);let h=await this.callTranscriptionApi(l);if(!h)continue;n.push({path:l.path,kind:"audio_transcript",content:h})}}return{folderPath:t.path,files:n}}async callSummaryApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in plugin settings.");let e=this.buildApiUrl(this.settings.apiSummaryPath),s={"Content-Type":"application/json"};this.settings.apiKey&&(s.Authorization=`Bearer ${this.settings.apiKey}`);let a=await this.requestJson(e,s,t);if(typeof a=="object"&&a!==null&&typeof a.summary=="string")return a.summary;throw new Error("Summary API returned an unexpected response.")}async writeSummaryFile(t,e){await this.ensureContextFolder(t);let s=this.getSummaryFilePath(t);await this.replaceTextFile(s,e)}async replaceTextFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s instanceof c.TFile){await this.app.vault.process(s,()=>e);return}await this.app.vault.create(t,e)}async appendTextFile(t,e,s=""){let a=this.app.vault.getAbstractFileByPath(t);if(a instanceof c.TFile){await this.app.vault.process(a,i=>i+e);return}await this.app.vault.create(t,`${s}${e}`)}async openChatForFolder(t){try{let e=this.collectFilesInFolder(t),s=await this.getSnapshotState(t,e);s.changed?(await this.archiveContextFolder(t),await this.ensureContextFolder(t),await this.writeSnapshot(t,e)):s.exists||(await this.ensureContextFolder(t),await this.writeSnapshot(t,e)),await this.ensureContextFolder(t),await this.ensureArtifactsFolder(t);let a=await this.readSummaryFile(t);if(a||(await this.summarizeFolder(t,e),a=await this.readSummaryFile(t)),!a){new c.Notice("Summary file not found. Unable to open chat.");return}let i=await this.getOrCreateChatLog(t),n=await this.loadChatHistory(i);if(n.length===0){let o=await this.findChatHistory(t,i,!0);o&&(n=this.stripTimestamps(o.entries),await this.writeChatLog(i,o.entries))}new D(this.app,this,a,t.name||t.path||"",t.path??"",this.settings.chatTheme,n,async(o,l,h,m)=>this.callChatApiStream(l,o,h,m),async o=>this.saveAssistantResponse(t,o),async(o,l)=>this.appendChatLog(i,o,l),async(o,l)=>this.downloadArtifacts(t,o,l)).open()}catch(e){this.showErrorModal(e)}}async readSummaryFile(t){let e=this.getSummaryFilePath(t),s=this.app.vault.getAbstractFileByPath(e);return s instanceof c.TFile?this.app.vault.read(s):null}async callChatApi(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let a=this.buildApiUrl(this.settings.apiChatPath),i={"Content-Type":"application/json"};this.settings.apiKey&&(i.Authorization=`Bearer ${this.settings.apiKey}`);let n=await this.requestJson(a,i,{summary:t,messages:this.stripTimestamps(e)},s),r=typeof n=="object"&&n!==null?n.message??n.response??n.content:void 0;if(typeof r=="string")return{message:r,artifactPaths:this.extractArtifactPaths(r)};throw new Error("Chat API returned an unexpected response.")}async callChatApiStream(t,e,s,a){try{return await this.callChatApiWebSocket(t,e,s,a)}catch(i){if(this.isAbortError(i))throw i;let n=await this.callChatApi(t,e,a);return n.message.length>0&&s(n.message),n}}async callChatApiWebSocket(t,e,s,a){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");if(typeof WebSocket!="function")throw new Error("WebSocket is not available in this environment.");let i=this.buildChatWebSocketUrl(),n=JSON.stringify({summary:t,messages:this.stripTimestamps(e),apiKey:this.settings.apiKey||void 0});return new Promise((r,o)=>{let l=!1,h="",m=new WebSocket(i),g=()=>{m.onopen=null,m.onmessage=null,m.onerror=null,m.onclose=null,a&&a.removeEventListener("abort",L),globalThis.clearTimeout(E)},y=p=>{l||(l=!0,g(),r(p))},f=p=>{l||(l=!0,g(),o(p))},F=p=>{y({message:p,artifactPaths:this.extractArtifactPaths(p)})},L=()=>{try{m.close(1e3,"aborted")}catch{}f(new Error("Request aborted"))},b=p=>{if(typeof p=="string"){let C=p.trim();if(C==="[DONE]"||C==="__DONE__"){F(h);try{m.close(1e3,"done")}catch{}return}h+=p,s(p);return}if(!p||typeof p!="object")return;let d=p;if(d.type==="error"){let C=typeof d.message=="string"?d.message:typeof d.error=="string"?d.error:"Chat websocket error.";throw new Error(C)}if(d.type==="chunk"){let C=typeof d.text=="string"?d.text:"";C.length>0&&(h+=C,s(C));return}if(d.type==="done"||d.done===!0){F(h);try{m.close(1e3,"done")}catch{}return}let T=typeof d.message=="string"?d.message:typeof d.response=="string"?d.response:typeof d.content=="string"?d.content:typeof d.text=="string"?d.text:null;T!==null&&(h+=T,s(T))},E=globalThis.setTimeout(()=>{try{m.close()}catch{}f(new Error("WebSocket connection timed out."))},vt);if(a){if(a.aborted){L();return}a.addEventListener("abort",L,{once:!0})}m.onopen=()=>{globalThis.clearTimeout(E),m.send(n)},m.onmessage=p=>{if(!l)try{if(typeof p.data=="string"){let d=p.data;try{b(JSON.parse(d))}catch{b(d)}return}if(p.data instanceof ArrayBuffer){let d=new TextDecoder().decode(p.data);try{b(JSON.parse(d))}catch{b(d)}return}b(String(p.data??""))}catch(d){f(d instanceof Error?d:new Error("Failed to process websocket frame."))}},m.onerror=()=>{f(new Error("WebSocket connection failed."))},m.onclose=p=>{if(!l){if(p.code===1e3){F(h);return}if(h.length>0){F(h);return}f(new Error(`WebSocket closed with code ${p.code}.`))}}})}async callTranscriptionApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let e=this.buildApiUrl(this.settings.apiTranscriptionPath),s=await this.app.vault.readBinary(t),a=this.getAudioContentType(t),i={path:t.path,name:t.name,data:J(s),contentType:a},n={"Content-Type":"application/json"};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`),n["X-Audio-Content-Type"]=a;let r=await this.requestJson(e,n,i),o=typeof r=="object"&&r!==null?r.text??r.transcript??r.transcription??null:null;if(typeof o=="string"&&o.length>0)return o;throw new Error("Transcription API returned an unexpected response.")}async loadSettings(){let t=await this.loadData(),e=t&&typeof t=="object"?t:{};this.settings=Object.assign({},rt,e)}async saveSettings(){await this.saveData(this.settings)}buildApiUrl(t){let e=this.settings.apiHost.trim(),s=e.endsWith("/")?e:`${e}/`,a=t.trim().replace(/^\/+/u,"");return new URL(a,s).toString()}buildChatWebSocketUrl(){let t=this.buildApiUrl(this.settings.apiChatPath),e=new URL(t);return e.protocol=e.protocol==="https:"?"wss:":"ws:",e.searchParams.has(K)||e.searchParams.set(K,yt),e.toString()}getContextPath(t){return`${t.path?`${t.path}/`:""}${Y}`}getArtifactsPath(t){return`${this.getContextPath(t)}/${G}`}getSummaryFilePath(t){return`${this.getContextPath(t)}/${this.settings.summaryFileName}`}async ensureFolderExists(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFolder)){if(e)throw new Error(`Path exists but is not a folder: ${t}`);await this.app.vault.createFolder(t)}}async ensureContextFolder(t){await this.ensureFolderExists(this.getContextPath(t))}async ensureArtifactsFolder(t){await this.ensureFolderExists(this.getArtifactsPath(t))}async requestJson(t,e,s,a){let i=await(0,c.requestUrl)({url:t,method:"POST",headers:e,body:JSON.stringify(s)});if(i.status<200||i.status>=300){let n=this.extractErrorDetail(i);throw new Error(n??`API error: ${i.status}`)}if(i.json)return i.json;try{return JSON.parse(i.text)}catch{throw new Error("API returned non-JSON response.")}}extractErrorDetail(t){let e=typeof t.json=="object"&&t.json!==null?t.json:null,s=e?.detail??e?.message;return typeof s=="string"&&s.trim().length>0?s.trim():t.text&&t.text.trim().length>0?t.text.trim():null}showErrorModal(t){let e=t instanceof Error?t.message:typeof t=="string"?t:"Unknown error.";new U(this.app,e).open()}isAbortError(t){return t instanceof Error?t.message.toLowerCase().includes("abort"):!1}async getSnapshotState(t,e){let s=await this.readSnapshot(t);if(!s)return{exists:!1,changed:!1};let a=new Map(e.map(i=>[i.path,i.stat.mtime]));if(s.files.length!==a.size)return{exists:!0,changed:!0};for(let i of s.files){let n=a.get(i.path);if(n===void 0||n!==i.mtime)return{exists:!0,changed:!0}}return{exists:!0,changed:!1}}async readSnapshot(t){let e=`${this.getContextPath(t)}/${V}`,s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s),i=JSON.parse(a);if(!i||typeof i!="object")return null;let n=i.files;if(!Array.isArray(n))return null;let r=n.filter(o=>!!o&&typeof o=="object"&&typeof o.path=="string"&&typeof o.mtime=="number");return r.length!==n.length?null:{files:r}}catch{return null}}async writeSnapshot(t,e){await this.ensureContextFolder(t);let s={files:e.map(n=>({path:n.path,mtime:n.stat.mtime}))},a=`${this.getContextPath(t)}/${V}`,i=JSON.stringify(s,null,2);await this.replaceTextFile(a,i)}async archiveContextFolder(t){let e=this.getContextPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFolder))return;let a=`${e}-${this.formatTimestamp(new Date)}`;await this.app.vault.rename(s,a)}async getOrCreateChatLog(t){await this.ensureContextFolder(t);let e=await this.readChatState(t);if(e?.activeLogPath){let n=this.app.vault.getAbstractFileByPath(e.activeLogPath);if(n instanceof c.TFile&&n.extension==="md")return e.activeLogPath}let s=this.getLatestChatLogPath(t);if(s)return await this.writeChatState(t,s),s;let a=`${j}${this.formatTimestamp(new Date)}.md`,i=`${this.getContextPath(t)}/${a}`;return await this.app.vault.create(i,`# Chat history

`),await this.writeChatState(t,i),i}getLatestChatLogPath(t){let e=this.getChatLogCandidates(t);return e.length===0?null:(e.sort((s,a)=>a.stat.mtime-s.stat.mtime),e[0].path)}getChatLogCandidates(t,e=!1){let s=this.getContextPath(t),a=[],i=o=>e?o.extension==="md"||o.extension==="json":o.extension==="md",n=o=>{for(let l of o.children){if(l instanceof c.TFolder){n(l);continue}l instanceof c.TFile&&l.name.startsWith(j)&&i(l)&&a.push(l)}},r=t.children.filter(o=>o instanceof c.TFolder&&(o.path===s||o.path.startsWith(`${s}-`)));for(let o of r)n(o);return a}async findChatHistory(t,e,s){let a=this.getChatLogCandidates(t,s);if(a.length===0)return null;a.sort((i,n)=>n.stat.mtime-i.stat.mtime);for(let i of a){if(i.path===e)continue;let n=await this.loadChatEntries(i.path);if(n.length>0)return{path:i.path,entries:n}}return null}async loadChatHistory(t){let e=await this.loadChatEntries(t);return this.stripTimestamps(e)}async loadChatEntries(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFile))return[];let s=await this.app.vault.read(e);return this.parseChatLog(s)}parseChatLog(t){let e=t.trim();if(e.startsWith("{")||e.startsWith("["))try{let l=JSON.parse(e),h=Array.isArray(l)?l:l.messages??l.history??l.items??l.log??[];return(Array.isArray(h)?h:[]).map(g=>{if(!g||typeof g!="object")return null;let y=g,f=y.role??y.type??y.author??y.sender??null;if(f!=="user"&&f!=="assistant"&&f!=="system")return null;let F=y.content??y.text??y.message??"";return typeof F!="string"?null:{role:f,content:F,timestamp:this.extractTimestamp(y)}}).filter(g=>!!g)}catch{}let s=[],a=t.split(/\r?\n/),i=null,n,r=[],o=()=>{if(i&&r.length>0){let l=r.join(`
`).trim();l.length>0&&s.push({role:i,content:l,timestamp:n})}};for(let l of a){let h=l.match(/^## \[(.+)\] (user|assistant)$/u);if(h){o(),i=h[2],n=h[1],r=[];continue}l.startsWith("# Chat history")||r.push(l)}return o(),s}async appendChatLog(t,e,s){let i=`## [${new Date().toISOString()}] ${e}
${s}

`;await this.appendTextFile(t,i,`# Chat history

`)}async writeChatLog(t,e){let s=`# Chat history

`,a=e.filter(n=>n.role==="user"||n.role==="assistant").map(n=>`## [${n.timestamp??new Date().toISOString()}] ${n.role}
${n.content}

`).join(""),i=s+a;await this.replaceTextFile(t,i)}stripTimestamps(t){return t.map(e=>({role:e.role,content:e.content}))}extractTimestamp(t){let e=t.timestamp??t.time??t.created_at??t.createdAt??t.date??t.ts??null;return this.normalizeTimestamp(e)??void 0}normalizeTimestamp(t){if(typeof t=="string"){let e=new Date(t);return Number.isNaN(e.getTime())?null:e.toISOString()}if(typeof t=="number"&&Number.isFinite(t)){let e=t<1e12?t*1e3:t,s=new Date(e);if(!Number.isNaN(s.getTime()))return s.toISOString()}return null}getChatStatePath(t){return`${this.getContextPath(t)}/${mt}`}async readChatState(t){let e=this.getChatStatePath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s),i=JSON.parse(a);return i&&typeof i=="object"&&typeof i.activeLogPath=="string"?{activeLogPath:i.activeLogPath}:null}catch{return null}}async writeChatState(t,e){await this.ensureContextFolder(t);let s=this.getChatStatePath(t),a=JSON.stringify({activeLogPath:e},null,2);await this.replaceTextFile(s,a)}extractArtifactPaths(t){let e=t.split(/\r?\n/),s=[],a=!1;for(let i of e){let n=i.trim();if(n.startsWith("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B:")){a=!0;continue}if(!a)continue;let r=n.match(/^-\s*(\/artifacts\/\S+)/u);if(r){s.push(r[1]);continue}if(n.length>0)break}return s}async downloadArtifacts(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");await this.ensureArtifactsFolder(t);for(let a of e){s(a,"\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430");try{let i=this.buildApiUrl(a),n={};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`);let r=await(0,c.requestUrl)({url:i,method:"GET",headers:n});if(r.status<200||r.status>=300)throw new Error(`Artifact download failed: ${r.status}`);let o=r.arrayBuffer??new TextEncoder().encode(r.text??"").buffer,l=this.getArtifactFilename(a),h=`${this.getArtifactsPath(t)}/${l}`,m=this.app.vault.getAbstractFileByPath(h);m instanceof c.TFile?await this.app.vault.modifyBinary(m,o):await this.app.vault.createBinary(h,o),s(a,"\u0433\u043E\u0442\u043E\u0432\u043E")}catch{s(a,"\u043E\u0448\u0438\u0431\u043A\u0430")}}}getArtifactFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}splitFiles(t){let e=[],s=[],a=[],i=[],n=[];for(let r of t){if(this.isSupportedAudioFile(r)){s.push(r);continue}if(this.isImageFile(r)){a.push(r);continue}if(this.isAnyAudioFile(r)){i.push(r);continue}if(this.isMarkdownFile(r)){e.push(r);continue}n.push(r)}return{textFiles:e,audioFiles:s,imageFiles:a,unsupportedAudioFiles:i,skippedFiles:n}}isMarkdownFile(t){return t.extension==="md"}isExcalidrawFile(t){return t.path.endsWith(".excalidraw.md")}isSupportedAudioFile(t){return lt.has(t.extension.toLowerCase())}isAnyAudioFile(t){return ht.has(t.extension.toLowerCase())}isImageFile(t){return ct.has(t.extension.toLowerCase())}getAudioContentType(t){let e=t.extension.toLowerCase();switch(e){case"mp3":case"m4a":return"audio/mpeg";case"ogg":case"opus":return"audio/ogg;codecs=opus";case"flac":return"audio/flac";case"wav":return"audio/x-pcm;bit=16;rate=16000";default:throw new Error(`Unsupported audio format: .${e}`)}}async saveAssistantResponse(t,e){await this.ensureContextFolder(t);let s=`${this.getContextPath(t)}/`,a=this.formatTimestamp(new Date),i=`ai-response-${a}.md`,n=`${s}${i}`,r=1;for(;this.app.vault.getAbstractFileByPath(n);)n=`${s}ai-response-${a}-${r}.md`,r+=1;await this.app.vault.create(n,e),new c.Notice(`Saved response to ${n}`)}formatTimestamp(t){let e=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getFullYear()).slice(-2),i=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return`${e}-${s}-${a}T${i}-${n}-${r}`}},B=class extends c.FuzzySuggestModal{constructor(t,e){super(t),this.onSelect=e,this.folders=this.collectFolders(),this.setPlaceholder("Select a folder to summarize")}getItems(){return this.folders}getItemText(t){return t.path||"/"}onChooseItem(t){this.onSelect(t)}collectFolders(){let t=this.app.vault.getAllLoadedFiles(),e=[];for(let s of t)s instanceof c.TFolder&&e.push(s);return e}},D=class extends c.Modal{constructor(t,e,s,a,i,n,r,o,l,h,m){super(t),this.markdownComponent=e,this.summary=s,this.folderLabel=a,this.theme=n,this.useSummary=!0,this.markdownSourcePath=i,this.onStream=o,this.onSave=l,this.onLog=h,this.onDownloadArtifacts=m,this.messages=[{role:"system",content:ot},...r],this.isWaiting=!1,this.requestCounter=0,this.canceledRequest=null,this.currentAbort=null,this.streamingRenderTarget=null,this.streamingRenderText="",this.streamingTypingTimer=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null,this.viewportTarget=null,this.viewportHandler=null,this.viewportMeasureRaf=null,this.viewportMeasureTimeout=null}onOpen(){let{contentEl:t}=this;t.empty(),this.modalEl.addClass("folder-summary-chat-modal"),t.addClass("folder-summary-chat"),this.theme==="glass"&&(this.modalEl.addClass("folder-summary-chat-modal--glass"),t.addClass("folder-summary-chat--glass")),this.theme==="quiet"&&(this.modalEl.addClass("folder-summary-chat-modal--quiet"),t.addClass("folder-summary-chat--quiet"));let e=t.createEl("div");e.addClass("folder-summary-chat__header"),e.createEl("h3",{text:"Chat with assistant 4sense"}).addClass("folder-summary-chat__title");let a=e.createEl("button");a.addClass("folder-summary-chat__close"),a.addClass("clickable-icon"),a.addClass("mod-close"),a.setAttr("aria-label","Close chat"),(0,c.setIcon)(a,"x"),a.onclick=()=>this.close();let i=t.createEl("div");i.addClass("folder-summary-chat__output"),i.tabIndex=-1;for(let u of this.messages)(u.role==="user"||u.role==="assistant")&&this.appendMessage(i,u.role,u.content);let n=t.createEl("div");n.addClass("folder-summary-chat__composer");let r=n.createEl("textarea");r.addClass("folder-summary-chat__input"),r.placeholder="Ask a question...";let o=null,l=(u,v)=>{if(!o)return;let x=n.getBoundingClientRect(),A=Math.max(0,Math.round(x.height));t.style.setProperty("--folder-summary-chat-composer-height",`${A}px`);let _=Math.max(24,A+16+u);i.style.setProperty("scroll-padding-bottom",`${_}px`);let k=r.getBoundingClientRect(),S=Math.max(0,Math.round(k.bottom-(v-8)));t.style.setProperty("--folder-summary-chat-keyboard-lift",`${S}px`),t.classList.toggle("folder-summary-chat--keyboard-force-lift",S>2)},h=()=>{globalThis.setTimeout(()=>{r.scrollIntoView({block:"end",behavior:"auto"})},80)},m=()=>{let u=globalThis.visualViewport,v=typeof u?.height=="number"?u.height:globalThis.innerHeight,x=typeof u?.offsetTop=="number"?u.offsetTop:0,A=x+v;this.modalEl.style.setProperty("--folder-summary-chat-vh",`${Math.max(320,Math.round(v))}px`);let _=Math.max(0,Math.round(globalThis.innerHeight-(v+x))),k=Math.max(0,Math.round(globalThis.innerHeight-v)),S=Math.max(_,k);this.modalEl.style.setProperty("--folder-summary-chat-keyboard-inset",`${S}px`),t.classList.toggle("folder-summary-chat--keyboard-open",S>20),l(S,A)},g=()=>{m(),this.viewportMeasureRaf!==null&&typeof globalThis.cancelAnimationFrame=="function"&&globalThis.cancelAnimationFrame(this.viewportMeasureRaf),this.viewportMeasureRaf=typeof globalThis.requestAnimationFrame=="function"?globalThis.requestAnimationFrame(()=>{this.viewportMeasureRaf=null,m()}):null,this.viewportMeasureTimeout!==null&&globalThis.clearTimeout(this.viewportMeasureTimeout),this.viewportMeasureTimeout=globalThis.setTimeout(()=>{this.viewportMeasureTimeout=null,m()},140)};g();let y=globalThis.visualViewport;if(y){let u=()=>{g(),this.contentEl.ownerDocument.activeElement===r&&h()};y.addEventListener("resize",u),y.addEventListener("scroll",u),this.viewportTarget=y,this.viewportHandler=u}r.addEventListener("focus",()=>{g(),h()}),r.addEventListener("blur",()=>{g()}),r.addEventListener("input",h);let f=n.createEl("button",{text:"Send"});f.addClass("folder-summary-chat__send");let F=u=>{this.isWaiting=u,r.disabled=u,u?(f.setText("Stop"),f.addClass("folder-summary-chat__send--stop")):(f.setText("Send"),f.removeClass("folder-summary-chat__send--stop"))},L=async()=>{let u=r.value.trim();if(!u||this.isWaiting)return;r.value="",this.appendMessage(i,"user",u),this.messages.push({role:"user",content:u}),await this.onLog("user",u),this.resetStreamingState();let v=this.appendLoadingMessage(i);i.scrollTop=i.scrollHeight,F(!0);let x=++this.requestCounter,A=new AbortController;this.currentAbort=A;let _="",k=!1,S=()=>{k||(k=!0,v.wrapper.removeClass("folder-summary-chat__message--loading"),v.body.empty(),v.body.addClass("folder-summary-chat__message-body--streaming"))};try{let M=await this.onStream(this.messages,this.useSummary?this.summary:"",P=>{S(),_+=P,this.updateStreamingMessage(v.body,_),i.scrollTop=i.scrollHeight},A.signal);if(this.canceledRequest===x)v.wrapper.remove();else{k||S();let P=M.message||_;if(this.messages.push({role:"assistant",content:P}),this.finalizeStreamingMessage(v.body,P),await this.onLog("assistant",P),M.artifactPaths.length>0){let Q=this.renderArtifactStatus(v.wrapper,M.artifactPaths);this.onDownloadArtifacts(M.artifactPaths,(Z,q)=>{let N=Q.get(Z);N&&(N.status.setText(q),N.open.classList.toggle("folder-summary-chat__artifact-open--disabled",q!=="\u0433\u043E\u0442\u043E\u0432\u043E"))})}}}catch(M){if(this.canceledRequest!==x){let P=M instanceof Error?M.message:"Failed to fetch response.";P.toLowerCase().includes("abort")?v.wrapper.remove():(S(),this.updateStreamingMessage(v.body,P))}else v.wrapper.remove()}finally{F(!1),this.canceledRequest=null,this.currentAbort=null}i.scrollTop=i.scrollHeight};f.onclick=()=>{if(this.isWaiting){this.canceledRequest=this.requestCounter,this.currentAbort?.abort(),F(!1);return}L()},r.addEventListener("keydown",u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),L())}),o=n.createEl("div"),o.addClass("folder-summary-chat__actions"),o.appendChild(f);let b=o.createEl("button",{text:"Summary"});b.addClass("folder-summary-chat__summary-open");let E=o.createEl("label");E.addClass("folder-summary-chat__summary-toggle");let p=E.createEl("input");p.type="checkbox",p.checked=!0,p.addClass("folder-summary-chat__summary-checkbox"),E.createEl("span").addClass("folder-summary-chat__summary-slider"),E.createEl("span",{text:"Use summary"}).addClass("folder-summary-chat__summary-toggle-label"),p.addEventListener("change",()=>{this.useSummary=p.checked}),g();let T=t.createEl("div");T.addClass("folder-summary-chat__summary-sheet"),T.addClass("folder-summary-chat__summary-sheet--hidden"),T.setAttr("aria-hidden","true");let C=T.createEl("div");C.addClass("folder-summary-chat__summary-panel");let R=C.createEl("div");R.addClass("folder-summary-chat__summary-header"),R.createEl("div",{text:`Summary: ${this.folderLabel}`}).addClass("folder-summary-chat__summary-header-title");let I=R.createEl("button",{text:"Close"});I.addClass("folder-summary-chat__summary-close"),C.createEl("pre",{text:this.summary}).addClass("folder-summary-chat__summary-text");let X=()=>{T.removeClass("folder-summary-chat__summary-sheet--hidden"),T.setAttr("aria-hidden","false"),I.focus()},H=()=>{T.addClass("folder-summary-chat__summary-sheet--hidden"),T.setAttr("aria-hidden","true")};b.onclick=()=>X(),I.onclick=()=>H(),T.addEventListener("click",u=>{u.target===T&&H()}),t.addEventListener("keydown",u=>{u.key==="Escape"&&!T.classList.contains("folder-summary-chat__summary-sheet--hidden")&&(u.preventDefault(),H())}),globalThis.setTimeout(()=>{this.contentEl.ownerDocument.activeElement===a&&i.focus({preventScroll:!0})},0)}onClose(){this.currentAbort?.abort(),this.currentAbort=null,this.resetStreamingState(),this.viewportTarget&&this.viewportHandler&&(this.viewportTarget.removeEventListener("resize",this.viewportHandler),this.viewportTarget.removeEventListener("scroll",this.viewportHandler)),this.viewportTarget=null,this.viewportHandler=null,this.viewportMeasureRaf!==null&&typeof globalThis.cancelAnimationFrame=="function"&&globalThis.cancelAnimationFrame(this.viewportMeasureRaf),this.viewportMeasureTimeout!==null&&globalThis.clearTimeout(this.viewportMeasureTimeout),this.viewportMeasureRaf=null,this.viewportMeasureTimeout=null,this.modalEl.style.removeProperty("--folder-summary-chat-vh"),this.modalEl.style.removeProperty("--folder-summary-chat-keyboard-inset"),this.contentEl.style.removeProperty("--folder-summary-chat-keyboard-lift"),this.contentEl.style.removeProperty("--folder-summary-chat-composer-height"),this.modalEl.removeClass("folder-summary-chat-modal"),this.modalEl.removeClass("folder-summary-chat-modal--glass"),this.modalEl.removeClass("folder-summary-chat-modal--quiet"),this.contentEl.removeClass("folder-summary-chat--glass"),this.contentEl.removeClass("folder-summary-chat--quiet"),this.contentEl.removeClass("folder-summary-chat--keyboard-open"),this.contentEl.removeClass("folder-summary-chat--keyboard-force-lift"),this.contentEl.empty()}appendMessage(t,e,s){let a=t.createEl("div");a.addClass("folder-summary-chat__message"),a.addClass(e==="user"?"folder-summary-chat__message--user":"folder-summary-chat__message--assistant"),a.createEl("div",{text:e==="user"?"\u0412\u044B":"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let n=a.createEl("div");if(n.addClass("folder-summary-chat__message-body"),e==="assistant"){this.renderAssistantMarkdown(n,s);let r=a.createEl("div");r.addClass("folder-summary-chat__message-actions");let o=r.createEl("button",{text:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C"});o.addClass("folder-summary-chat__message-save"),o.onclick=()=>void this.onSave(s)}else n.setText(s)}appendLoadingMessage(t){let e=t.createEl("div");e.addClass("folder-summary-chat__message"),e.addClass("folder-summary-chat__message--assistant"),e.addClass("folder-summary-chat__message--loading"),e.createEl("div",{text:"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let a=e.createEl("div");a.addClass("folder-summary-chat__message-body");let i=a.createEl("span");i.addClass("folder-summary-chat__loading-dots");for(let n=0;n<3;n+=1){let r=i.createEl("span",{text:"."});r.addClass("folder-summary-chat__loading-dot"),r.setAttr("aria-hidden","true")}return{wrapper:e,body:a}}updateStreamingMessage(t,e){t.addClass("folder-summary-chat__message-body--streaming"),this.updateTypingText(t,e)}finalizeStreamingMessage(t,e){this.queueFinalize(t,e)}renderAssistantMarkdown(t,e){t.empty(),c.MarkdownRenderer.render(this.app,e,t,this.markdownSourcePath,this.markdownComponent)}updateTypingText(t,e){this.streamingRenderTarget!==t&&(this.streamingRenderTarget=t,this.streamingTypingProgress=0),this.streamingRenderText=e,this.streamingTypingTimer===null&&(this.streamingTypingTimer=globalThis.setInterval(()=>this.tickStreamingTyping(),dt))}stopStreamingTyping(){this.streamingTypingTimer!==null&&(globalThis.clearInterval(this.streamingTypingTimer),this.streamingTypingTimer=null),this.streamingTypingProgress=0}tickStreamingTyping(){if(!this.streamingRenderTarget){this.stopStreamingTyping();return}let t=this.streamingRenderText;if(!t){this.stopStreamingTyping();return}let e=t.length-this.streamingTypingProgress;if(e<=0){if(this.streamingFinalizeTarget){let i=this.streamingFinalizeTarget;this.streamingFinalizeTarget=null,this.completeFinalize(i.body,i.text)}else this.stopStreamingTyping();return}let s=Math.ceil(e/ft),a=Math.max(gt,s);this.streamingTypingProgress=Math.min(t.length,this.streamingTypingProgress+a),this.streamingRenderTarget.setText(t.slice(0,this.streamingTypingProgress))}queueFinalize(t,e){this.streamingFinalizeTarget={body:t,text:e},this.streamingTypingTimer===null&&this.completeFinalize(t,e)}completeFinalize(t,e){this.stopStreamingTyping(),t.removeClass("folder-summary-chat__message-body--streaming"),this.renderAssistantMarkdown(t,e)}resetStreamingState(){this.stopStreamingTyping(),this.streamingRenderText="",this.streamingRenderTarget=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null}renderArtifactStatus(t,e){let s=new Map;t.createEl("div",{text:"\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B"}).addClass("folder-summary-chat__artifact-title");let i=t.createEl("ul");i.addClass("folder-summary-chat__artifact-list");for(let n of e){let r=this.extractFilename(n),o=this.isArtifactDownloaded(n),l=i.createEl("li");l.addClass("folder-summary-chat__artifact-item");let h=l.createEl("a",{text:r});h.href="#",h.onclick=g=>{if(g.preventDefault(),h.classList.contains("folder-summary-chat__artifact-open--disabled")){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}this.openArtifact(n)},h.addClass("folder-summary-chat__artifact-name"),h.addClass("folder-summary-chat__artifact-open"),o||h.addClass("folder-summary-chat__artifact-open--disabled");let m=l.createEl("span",{text:o?"\u0433\u043E\u0442\u043E\u0432\u043E":"\u043E\u0436\u0438\u0434\u0430\u043D\u0438\u0435"});m.addClass("folder-summary-chat__artifact-status"),s.set(n,{status:m,open:h})}return s}getArtifactLocalPath(t){return`${this.markdownSourcePath?`${this.markdownSourcePath}/`:""}${Y}/${G}/${this.extractFilename(t)}`}isArtifactDownloaded(t){return this.app.vault.getAbstractFileByPath(this.getArtifactLocalPath(t))instanceof c.TFile}async openArtifact(t){let e=this.getArtifactLocalPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile)){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}await this.app.workspace.getLeaf(!0).openFile(s)}extractFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}},z=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new c.Setting(t).setName("API host").setDesc("Host URL for the future summary/chat API.").addText(e=>e.setPlaceholder("https://api.example.com").setValue(this.plugin.settings.apiHost).onChange(async s=>{this.plugin.settings.apiHost=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("API key").setDesc("API key used for authentication.").addText(e=>e.setPlaceholder("API key").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary endpoint path").setDesc("Path for summary API (relative to host).").addText(e=>e.setPlaceholder("/summaries").setValue(this.plugin.settings.apiSummaryPath).onChange(async s=>{this.plugin.settings.apiSummaryPath=s.trim()||"/summaries",await this.plugin.saveSettings()})),new c.Setting(t).setName("Transcription endpoint path").setDesc("Path for audio transcription API (relative to host).").addText(e=>e.setPlaceholder("/transcriptions").setValue(this.plugin.settings.apiTranscriptionPath).onChange(async s=>{this.plugin.settings.apiTranscriptionPath=s.trim()||"/transcriptions",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat endpoint path").setDesc("Path for chat API (relative to host).").addText(e=>e.setPlaceholder("/chat").setValue(this.plugin.settings.apiChatPath).onChange(async s=>{this.plugin.settings.apiChatPath=s.trim()||"/chat",await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary file name").setDesc("File name for the summary saved in the folder.").addText(e=>e.setPlaceholder("_summary.md").setValue(this.plugin.settings.summaryFileName).onChange(async s=>{this.plugin.settings.summaryFileName=s.trim()||"_summary.md",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat theme").setDesc("Visual style for the chat modal.").addDropdown(e=>e.addOption("glass","iOS glass").addOption("quiet","iOS calm").addOption("classic","iOS classic").setValue(this.plugin.settings.chatTheme).onChange(async s=>{this.plugin.settings.chatTheme=s==="classic"||s==="quiet"?s:"glass",await this.plugin.saveSettings()}))}},W=class extends c.Modal{constructor(){super(...arguments);this.statusEl=null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("devbrief-progress"),e.createEl("div").addClass("devbrief-progress__spinner");let a=e.createEl("div",{text:"..."});a.addClass("devbrief-progress__status"),this.statusEl=a}setStatus(e){this.statusEl&&this.statusEl.setText(e)}onClose(){this.contentEl.empty(),this.statusEl=null}},U=class extends c.Modal{constructor(t,e){super(t),this.message=e}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("devbrief-error"),t.createEl("h3",{text:"\u041E\u0448\u0438\u0431\u043A\u0430"}),t.createEl("p",{text:"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0449\u0435\u043D\u0438\u0438 \u043A API."}),t.createEl("pre",{text:this.message})}onClose(){this.contentEl.empty()}};function J(w){let t="",e=new Uint8Array(w),s=8192;for(let a=0;a<e.length;a+=s){let i=e.subarray(a,a+s);t+=String.fromCharCode(...i)}if(typeof globalThis.btoa!="function")throw new Error("btoa is not available in this environment.");return globalThis.btoa(t)}
