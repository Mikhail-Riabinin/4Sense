"use strict";var I=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var tt=Object.prototype.hasOwnProperty;var et=(y,t)=>{for(var e in t)I(y,e,{get:t[e],enumerable:!0})},st=(y,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Z(t))!tt.call(y,a)&&a!==e&&I(y,a,{get:()=>t[a],enumerable:!(s=Q(t,a))||s.enumerable});return y};var at=y=>st(I({},"__esModule",{value:!0}),y);var yt={};et(yt,{default:()=>A});module.exports=at(yt);var c=require("obsidian"),it={apiHost:"",apiKey:"",apiSummaryPath:"/summaries",apiTranscriptionPath:"/transcriptions",apiChatPath:"/chat",summaryFileName:"_summary.md",chatTheme:"quiet"},nt="You are a helpful assistant. Use the provided folder summary as context.",rt=new Set(["mp3","wav","m4a","ogg","flac","opus"]),ot=new Set(["png","jpg","jpeg","gif","webp"]),lt=new Set(["mp3","wav","m4a","aac","ogg","flac","opus","webm"]),ct=10*1024*1024,K="4senseContext",J="artefacts",U="chat-",ht="chat-state.json",j="snapshot.json",ut=120,mt=Math.max(24,Math.floor(ut/4)),dt=2,pt=20,q="websocket",gt="True",ft=8e3,A=class extends c.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new N(this.app,this)),this.addCommand({id:"summarize-folder-select",name:"Summarize folder (select)",callback:()=>this.openFolderSelectModal(t=>{this.summarizeFolder(t)})}),this.addCommand({id:"summarize-current-folder",name:"Summarize current file folder",callback:()=>this.summarizeCurrentFileFolder()}),this.app.workspace.onLayoutReady(()=>this.registerUiActions())}onunload(){}async summarizeCurrentFileFolder(){let t=this.getCurrentFileFolder();if(!t){new c.Notice("No active file to determine folder.");return}await this.summarizeFolder(t)}getCurrentFileFolder(){let t=this.app.workspace.getActiveFile();if(!t)return null;let e=t.parent;return e instanceof c.TFolder?e:null}openFolderSelectModal(t){new R(this.app,t).open()}registerUiActions(){this.addRibbonIcon("sparkles","Chat with assistant 4sense",()=>{this.openFolderSelectModal(e=>{this.openChatForFolder(e)})}),this.registerEvent(this.app.workspace.on("file-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(i=>i.setTitle("Chat with assistant 4sense").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}));let t=this.app.workspace;this.registerEvent(t.on("file-explorer-context-menu",(e,s)=>{let a=this.resolveFolderFromAbstractFile(s);a&&e.addItem(i=>i.setTitle("Chat with assistant 4sense").setIcon("sparkles").onClick(()=>this.openChatForFolder(a)))}))}resolveFolderFromAbstractFile(t){return t?t instanceof c.TFolder?t:t instanceof c.TFile&&t.parent instanceof c.TFolder?t.parent:null:null}async summarizeFolder(t,e){let s=new O(this.app);s.open();try{s.setStatus("\u0421\u043A\u0430\u043D\u0438\u0440\u0443\u044E \u0444\u0430\u0439\u043B\u044B...");let a=e??this.collectFilesInFolder(t),{textFiles:i,audioFiles:n,imageFiles:o,unsupportedAudioFiles:r,skippedFiles:l}=this.splitFiles(a);if(i.length===0&&n.length===0&&o.length===0){new c.Notice("No supported files found in the selected folder.");return}if(r.length>0){let g=r.map(v=>v.name).slice(0,3).join(", "),f=r.length>3?` (+${r.length-3} more)`:"";new c.Notice(`Unsupported audio formats: ${g}${f}`)}l.length>0&&new c.Notice(`Skipping ${l.length} unsupported files.`),s.setStatus("\u0413\u043E\u0442\u043E\u0432\u043B\u044E \u0434\u0430\u043D\u043D\u044B\u0435...");let h=await this.buildSummaryPayload(t,a,n.length,o,g=>s.setStatus(g));s.setStatus("\u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u044E \u0434\u0430\u043D\u043D\u044B\u0435 \u043D\u0430 \u0441\u0443\u043C\u043C\u0430\u0440\u0438\u0437\u0430\u0446\u0438\u044E...");let u=await this.callSummaryApi(h);s.setStatus("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u044E \u0441\u0430\u043C\u043C\u0430\u0440\u0438..."),await this.writeSummaryFile(t,u),await this.writeSnapshot(t,a),new c.Notice("Summary saved.")}catch(a){this.showErrorModal(a)}finally{s.close()}}collectFilesInFolder(t){let e=this.getContextPath(t),s=this.getArtifactsPath(t),a=`${e}/${this.settings.summaryFileName}`,i=[],n=o=>{for(let r of o.children){if(r instanceof c.TFolder){if(r.path===e||r.path.startsWith(`${e}-`)||r.path===s||r.path.startsWith(`${s}/`))continue;n(r);continue}r instanceof c.TFile&&(r.path===a||r.path.startsWith(`${e}/`)||r.path.startsWith(`${e}-`)||r.path.startsWith(`${s}/`)||i.push(r))}};return n(t),i.sort((o,r)=>o.stat.ctime-r.stat.ctime),i}async buildSummaryPayload(t,e,s,a,i){let n=[],o=new Set(a.map(l=>l.path)),r=0;for(let l of e){if(this.isMarkdownFile(l)){let h=await this.app.vault.read(l);n.push({path:l.path,kind:this.isExcalidrawFile(l)?"excalidraw":"markdown",content:h});continue}if(o.has(l.path)){if(l.stat.size>ct){i&&i(`\u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u044E \u0431\u043E\u043B\u044C\u0448\u043E\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);continue}i&&i(`\u0414\u043E\u0431\u0430\u0432\u043B\u044F\u044E \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435: ${l.name}`);let u=V(await this.app.vault.readBinary(l));n.push({path:l.path,kind:"image",content:u});continue}if(this.isSupportedAudioFile(l)){r+=1,i&&i(`\u0422\u0440\u0430\u043D\u0441\u043A\u0440\u0438\u0431\u0438\u0440\u0443\u044E \u0430\u0443\u0434\u0438\u043E ${r}/${s}: ${l.name}`);let h=await this.callTranscriptionApi(l);if(!h)continue;n.push({path:l.path,kind:"audio_transcript",content:h})}}return{folderPath:t.path,files:n}}async callSummaryApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in plugin settings.");let e=this.buildApiUrl(this.settings.apiSummaryPath),s={"Content-Type":"application/json"};this.settings.apiKey&&(s.Authorization=`Bearer ${this.settings.apiKey}`);let a=await this.requestJson(e,s,t);if(typeof a=="object"&&a!==null&&typeof a.summary=="string")return a.summary;throw new Error("Summary API returned an unexpected response.")}async writeSummaryFile(t,e){await this.ensureContextFolder(t);let s=this.getSummaryFilePath(t);await this.replaceTextFile(s,e)}async replaceTextFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s instanceof c.TFile){await this.app.vault.process(s,()=>e);return}await this.app.vault.create(t,e)}async appendTextFile(t,e,s=""){let a=this.app.vault.getAbstractFileByPath(t);if(a instanceof c.TFile){await this.app.vault.process(a,i=>i+e);return}await this.app.vault.create(t,`${s}${e}`)}async openChatForFolder(t){try{let e=this.collectFilesInFolder(t),s=await this.getSnapshotState(t,e);s.changed?(await this.archiveContextFolder(t),await this.ensureContextFolder(t),await this.writeSnapshot(t,e)):s.exists||(await this.ensureContextFolder(t),await this.writeSnapshot(t,e)),await this.ensureContextFolder(t),await this.ensureArtifactsFolder(t);let a=await this.readSummaryFile(t);if(a||(await this.summarizeFolder(t,e),a=await this.readSummaryFile(t)),!a){new c.Notice("Summary file not found. Unable to open chat.");return}let i=await this.getOrCreateChatLog(t),n=await this.loadChatHistory(i);if(n.length===0){let r=await this.findChatHistory(t,i,!0);r&&(n=this.stripTimestamps(r.entries),await this.writeChatLog(i,r.entries))}new H(this.app,this,a,t.name||t.path||"",t.path??"",this.settings.chatTheme,n,async(r,l,h,u)=>this.callChatApiStream(l,r,h,u),async r=>this.saveAssistantResponse(t,r),async(r,l)=>this.appendChatLog(i,r,l),async(r,l)=>this.downloadArtifacts(t,r,l)).open()}catch(e){this.showErrorModal(e)}}async readSummaryFile(t){let e=this.getSummaryFilePath(t),s=this.app.vault.getAbstractFileByPath(e);return s instanceof c.TFile?this.app.vault.read(s):null}async callChatApi(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let a=this.buildApiUrl(this.settings.apiChatPath),i={"Content-Type":"application/json"};this.settings.apiKey&&(i.Authorization=`Bearer ${this.settings.apiKey}`);let n=await this.requestJson(a,i,{summary:t,messages:this.stripTimestamps(e)},s),o=typeof n=="object"&&n!==null?n.message??n.response??n.content:void 0;if(typeof o=="string")return{message:o,artifactPaths:this.extractArtifactPaths(o)};throw new Error("Chat API returned an unexpected response.")}async callChatApiStream(t,e,s,a){try{return await this.callChatApiWebSocket(t,e,s,a)}catch(i){if(this.isAbortError(i))throw i;let n=await this.callChatApi(t,e,a);return n.message.length>0&&s(n.message),n}}async callChatApiWebSocket(t,e,s,a){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");if(typeof WebSocket!="function")throw new Error("WebSocket is not available in this environment.");let i=this.buildChatWebSocketUrl(),n=JSON.stringify({summary:t,messages:this.stripTimestamps(e),apiKey:this.settings.apiKey||void 0});return new Promise((o,r)=>{let l=!1,h="",u=new WebSocket(i),g=()=>{u.onopen=null,u.onmessage=null,u.onerror=null,u.onclose=null,a&&a.removeEventListener("abort",F),globalThis.clearTimeout(w)},f=p=>{l||(l=!0,g(),o(p))},v=p=>{l||(l=!0,g(),r(p))},C=p=>{f({message:p,artifactPaths:this.extractArtifactPaths(p)})},F=()=>{try{u.close(1e3,"aborted")}catch{}v(new Error("Request aborted"))},x=p=>{if(typeof p=="string"){let S=p.trim();if(S==="[DONE]"||S==="__DONE__"){C(h);try{u.close(1e3,"done")}catch{}return}h+=p,s(p);return}if(!p||typeof p!="object")return;let m=p;if(m.type==="error"){let S=typeof m.message=="string"?m.message:typeof m.error=="string"?m.error:"Chat websocket error.";throw new Error(S)}if(m.type==="chunk"){let S=typeof m.text=="string"?m.text:"";S.length>0&&(h+=S,s(S));return}if(m.type==="done"||m.done===!0){C(h);try{u.close(1e3,"done")}catch{}return}let b=typeof m.message=="string"?m.message:typeof m.response=="string"?m.response:typeof m.content=="string"?m.content:typeof m.text=="string"?m.text:null;b!==null&&(h+=b,s(b))},w=globalThis.setTimeout(()=>{try{u.close()}catch{}v(new Error("WebSocket connection timed out."))},ft);if(a){if(a.aborted){F();return}a.addEventListener("abort",F,{once:!0})}u.onopen=()=>{globalThis.clearTimeout(w),u.send(n)},u.onmessage=p=>{if(!l)try{if(typeof p.data=="string"){let m=p.data;try{x(JSON.parse(m))}catch{x(m)}return}if(p.data instanceof ArrayBuffer){let m=new TextDecoder().decode(p.data);try{x(JSON.parse(m))}catch{x(m)}return}x(String(p.data??""))}catch(m){v(m instanceof Error?m:new Error("Failed to process websocket frame."))}},u.onerror=()=>{v(new Error("WebSocket connection failed."))},u.onclose=p=>{if(!l){if(p.code===1e3){C(h);return}if(h.length>0){C(h);return}v(new Error(`WebSocket closed with code ${p.code}.`))}}})}async callTranscriptionApi(t){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");let e=this.buildApiUrl(this.settings.apiTranscriptionPath),s=await this.app.vault.readBinary(t),a=this.getAudioContentType(t),i={path:t.path,name:t.name,data:V(s),contentType:a},n={"Content-Type":"application/json"};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`),n["X-Audio-Content-Type"]=a;let o=await this.requestJson(e,n,i),r=typeof o=="object"&&o!==null?o.text??o.transcript??o.transcription??null:null;if(typeof r=="string"&&r.length>0)return r;throw new Error("Transcription API returned an unexpected response.")}async loadSettings(){let t=await this.loadData(),e=t&&typeof t=="object"?t:{};this.settings=Object.assign({},it,e)}async saveSettings(){await this.saveData(this.settings)}buildApiUrl(t){let e=this.settings.apiHost.trim(),s=e.endsWith("/")?e:`${e}/`,a=t.trim().replace(/^\/+/u,"");return new URL(a,s).toString()}buildChatWebSocketUrl(){let t=this.buildApiUrl(this.settings.apiChatPath),e=new URL(t);return e.protocol=e.protocol==="https:"?"wss:":"ws:",e.searchParams.has(q)||e.searchParams.set(q,gt),e.toString()}getContextPath(t){return`${t.path?`${t.path}/`:""}${K}`}getArtifactsPath(t){return`${this.getContextPath(t)}/${J}`}getSummaryFilePath(t){return`${this.getContextPath(t)}/${this.settings.summaryFileName}`}async ensureFolderExists(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFolder)){if(e)throw new Error(`Path exists but is not a folder: ${t}`);await this.app.vault.createFolder(t)}}async ensureContextFolder(t){await this.ensureFolderExists(this.getContextPath(t))}async ensureArtifactsFolder(t){await this.ensureFolderExists(this.getArtifactsPath(t))}async requestJson(t,e,s,a){let i=await(0,c.requestUrl)({url:t,method:"POST",headers:e,body:JSON.stringify(s)});if(i.status<200||i.status>=300){let n=this.extractErrorDetail(i);throw new Error(n??`API error: ${i.status}`)}if(i.json)return i.json;try{return JSON.parse(i.text)}catch{throw new Error("API returned non-JSON response.")}}extractErrorDetail(t){let e=typeof t.json=="object"&&t.json!==null?t.json:null,s=e?.detail??e?.message;return typeof s=="string"&&s.trim().length>0?s.trim():t.text&&t.text.trim().length>0?t.text.trim():null}showErrorModal(t){let e=t instanceof Error?t.message:typeof t=="string"?t:"Unknown error.";new D(this.app,e).open()}isAbortError(t){return t instanceof Error?t.message.toLowerCase().includes("abort"):!1}async getSnapshotState(t,e){let s=await this.readSnapshot(t);if(!s)return{exists:!1,changed:!1};let a=new Map(e.map(i=>[i.path,i.stat.mtime]));if(s.files.length!==a.size)return{exists:!0,changed:!0};for(let i of s.files){let n=a.get(i.path);if(n===void 0||n!==i.mtime)return{exists:!0,changed:!0}}return{exists:!0,changed:!1}}async readSnapshot(t){let e=`${this.getContextPath(t)}/${j}`,s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s),i=JSON.parse(a);if(!i||typeof i!="object")return null;let n=i.files;if(!Array.isArray(n))return null;let o=n.filter(r=>!!r&&typeof r=="object"&&typeof r.path=="string"&&typeof r.mtime=="number");return o.length!==n.length?null:{files:o}}catch{return null}}async writeSnapshot(t,e){await this.ensureContextFolder(t);let s={files:e.map(n=>({path:n.path,mtime:n.stat.mtime}))},a=`${this.getContextPath(t)}/${j}`,i=JSON.stringify(s,null,2);await this.replaceTextFile(a,i)}async archiveContextFolder(t){let e=this.getContextPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFolder))return;let a=`${e}-${this.formatTimestamp(new Date)}`;await this.app.vault.rename(s,a)}async getOrCreateChatLog(t){await this.ensureContextFolder(t);let e=await this.readChatState(t);if(e?.activeLogPath){let n=this.app.vault.getAbstractFileByPath(e.activeLogPath);if(n instanceof c.TFile&&n.extension==="md")return e.activeLogPath}let s=this.getLatestChatLogPath(t);if(s)return await this.writeChatState(t,s),s;let a=`${U}${this.formatTimestamp(new Date)}.md`,i=`${this.getContextPath(t)}/${a}`;return await this.app.vault.create(i,`# Chat history

`),await this.writeChatState(t,i),i}getLatestChatLogPath(t){let e=this.getChatLogCandidates(t);return e.length===0?null:(e.sort((s,a)=>a.stat.mtime-s.stat.mtime),e[0].path)}getChatLogCandidates(t,e=!1){let s=this.getContextPath(t),a=[],i=r=>e?r.extension==="md"||r.extension==="json":r.extension==="md",n=r=>{for(let l of r.children){if(l instanceof c.TFolder){n(l);continue}l instanceof c.TFile&&l.name.startsWith(U)&&i(l)&&a.push(l)}},o=t.children.filter(r=>r instanceof c.TFolder&&(r.path===s||r.path.startsWith(`${s}-`)));for(let r of o)n(r);return a}async findChatHistory(t,e,s){let a=this.getChatLogCandidates(t,s);if(a.length===0)return null;a.sort((i,n)=>n.stat.mtime-i.stat.mtime);for(let i of a){if(i.path===e)continue;let n=await this.loadChatEntries(i.path);if(n.length>0)return{path:i.path,entries:n}}return null}async loadChatHistory(t){let e=await this.loadChatEntries(t);return this.stripTimestamps(e)}async loadChatEntries(t){let e=this.app.vault.getAbstractFileByPath(t);if(!(e instanceof c.TFile))return[];let s=await this.app.vault.read(e);return this.parseChatLog(s)}parseChatLog(t){let e=t.trim();if(e.startsWith("{")||e.startsWith("["))try{let l=JSON.parse(e),h=Array.isArray(l)?l:l.messages??l.history??l.items??l.log??[];return(Array.isArray(h)?h:[]).map(g=>{if(!g||typeof g!="object")return null;let f=g,v=f.role??f.type??f.author??f.sender??null;if(v!=="user"&&v!=="assistant"&&v!=="system")return null;let C=f.content??f.text??f.message??"";return typeof C!="string"?null:{role:v,content:C,timestamp:this.extractTimestamp(f)}}).filter(g=>!!g)}catch{}let s=[],a=t.split(/\r?\n/),i=null,n,o=[],r=()=>{if(i&&o.length>0){let l=o.join(`
`).trim();l.length>0&&s.push({role:i,content:l,timestamp:n})}};for(let l of a){let h=l.match(/^## \[(.+)\] (user|assistant)$/u);if(h){r(),i=h[2],n=h[1],o=[];continue}l.startsWith("# Chat history")||o.push(l)}return r(),s}async appendChatLog(t,e,s){let i=`## [${new Date().toISOString()}] ${e}
${s}

`;await this.appendTextFile(t,i,`# Chat history

`)}async writeChatLog(t,e){let s=`# Chat history

`,a=e.filter(n=>n.role==="user"||n.role==="assistant").map(n=>`## [${n.timestamp??new Date().toISOString()}] ${n.role}
${n.content}

`).join(""),i=s+a;await this.replaceTextFile(t,i)}stripTimestamps(t){return t.map(e=>({role:e.role,content:e.content}))}extractTimestamp(t){let e=t.timestamp??t.time??t.created_at??t.createdAt??t.date??t.ts??null;return this.normalizeTimestamp(e)??void 0}normalizeTimestamp(t){if(typeof t=="string"){let e=new Date(t);return Number.isNaN(e.getTime())?null:e.toISOString()}if(typeof t=="number"&&Number.isFinite(t)){let e=t<1e12?t*1e3:t,s=new Date(e);if(!Number.isNaN(s.getTime()))return s.toISOString()}return null}getChatStatePath(t){return`${this.getContextPath(t)}/${ht}`}async readChatState(t){let e=this.getChatStatePath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile))return null;try{let a=await this.app.vault.read(s),i=JSON.parse(a);return i&&typeof i=="object"&&typeof i.activeLogPath=="string"?{activeLogPath:i.activeLogPath}:null}catch{return null}}async writeChatState(t,e){await this.ensureContextFolder(t);let s=this.getChatStatePath(t),a=JSON.stringify({activeLogPath:e},null,2);await this.replaceTextFile(s,a)}extractArtifactPaths(t){let e=t.split(/\r?\n/),s=[],a=!1;for(let i of e){let n=i.trim();if(n.startsWith("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B:")){a=!0;continue}if(!a)continue;let o=n.match(/^-\s*(\/artifacts\/\S+)/u);if(o){s.push(o[1]);continue}if(n.length>0)break}return s}async downloadArtifacts(t,e,s){if(!this.settings.apiHost)throw new Error("API host is not configured. Set it in settings.");await this.ensureArtifactsFolder(t);for(let a of e){s(a,"\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430");try{let i=this.buildApiUrl(a),n={};this.settings.apiKey&&(n.Authorization=`Bearer ${this.settings.apiKey}`);let o=await(0,c.requestUrl)({url:i,method:"GET",headers:n});if(o.status<200||o.status>=300)throw new Error(`Artifact download failed: ${o.status}`);let r=o.arrayBuffer??new TextEncoder().encode(o.text??"").buffer,l=this.getArtifactFilename(a),h=`${this.getArtifactsPath(t)}/${l}`,u=this.app.vault.getAbstractFileByPath(h);u instanceof c.TFile?await this.app.vault.modifyBinary(u,r):await this.app.vault.createBinary(h,r),s(a,"\u0433\u043E\u0442\u043E\u0432\u043E")}catch{s(a,"\u043E\u0448\u0438\u0431\u043A\u0430")}}}getArtifactFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}splitFiles(t){let e=[],s=[],a=[],i=[],n=[];for(let o of t){if(this.isSupportedAudioFile(o)){s.push(o);continue}if(this.isImageFile(o)){a.push(o);continue}if(this.isAnyAudioFile(o)){i.push(o);continue}if(this.isMarkdownFile(o)){e.push(o);continue}n.push(o)}return{textFiles:e,audioFiles:s,imageFiles:a,unsupportedAudioFiles:i,skippedFiles:n}}isMarkdownFile(t){return t.extension==="md"}isExcalidrawFile(t){return t.path.endsWith(".excalidraw.md")}isSupportedAudioFile(t){return rt.has(t.extension.toLowerCase())}isAnyAudioFile(t){return lt.has(t.extension.toLowerCase())}isImageFile(t){return ot.has(t.extension.toLowerCase())}getAudioContentType(t){let e=t.extension.toLowerCase();switch(e){case"mp3":case"m4a":return"audio/mpeg";case"ogg":case"opus":return"audio/ogg;codecs=opus";case"flac":return"audio/flac";case"wav":return"audio/x-pcm;bit=16;rate=16000";default:throw new Error(`Unsupported audio format: .${e}`)}}async saveAssistantResponse(t,e){await this.ensureContextFolder(t);let s=`${this.getContextPath(t)}/`,a=this.formatTimestamp(new Date),i=`ai-response-${a}.md`,n=`${s}${i}`,o=1;for(;this.app.vault.getAbstractFileByPath(n);)n=`${s}ai-response-${a}-${o}.md`,o+=1;await this.app.vault.create(n,e),new c.Notice(`Saved response to ${n}`)}formatTimestamp(t){let e=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getFullYear()).slice(-2),i=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0");return`${e}-${s}-${a}T${i}-${n}-${o}`}},R=class extends c.FuzzySuggestModal{constructor(t,e){super(t),this.onSelect=e,this.folders=this.collectFolders(),this.setPlaceholder("Select a folder to summarize")}getItems(){return this.folders}getItemText(t){return t.path||"/"}onChooseItem(t){this.onSelect(t)}collectFolders(){let t=this.app.vault.getAllLoadedFiles(),e=[];for(let s of t)s instanceof c.TFolder&&e.push(s);return e}},H=class extends c.Modal{constructor(t,e,s,a,i,n,o,r,l,h,u){super(t),this.markdownComponent=e,this.summary=s,this.folderLabel=a,this.theme=n,this.useSummary=!0,this.markdownSourcePath=i,this.onStream=r,this.onSave=l,this.onLog=h,this.onDownloadArtifacts=u,this.messages=[{role:"system",content:nt},...o],this.isWaiting=!1,this.requestCounter=0,this.canceledRequest=null,this.currentAbort=null,this.streamingRenderTarget=null,this.streamingRenderText="",this.streamingTypingTimer=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null,this.viewportTarget=null,this.viewportHandler=null}onOpen(){let{contentEl:t}=this;t.empty(),this.modalEl.addClass("folder-summary-chat-modal"),t.addClass("folder-summary-chat"),this.theme==="glass"&&(this.modalEl.addClass("folder-summary-chat-modal--glass"),t.addClass("folder-summary-chat--glass")),this.theme==="quiet"&&(this.modalEl.addClass("folder-summary-chat-modal--quiet"),t.addClass("folder-summary-chat--quiet"));let e=t.createEl("div");e.addClass("folder-summary-chat__header"),e.createEl("h3",{text:"Chat with assistant 4sense"}).addClass("folder-summary-chat__title");let a=e.createEl("button");a.addClass("folder-summary-chat__close"),a.addClass("clickable-icon"),a.addClass("mod-close"),a.setAttr("aria-label","Close chat"),(0,c.setIcon)(a,"x"),a.onclick=()=>this.close();let i=t.createEl("div");i.addClass("folder-summary-chat__output"),i.tabIndex=-1;for(let d of this.messages)(d.role==="user"||d.role==="assistant")&&this.appendMessage(i,d.role,d.content);let n=t.createEl("textarea");n.addClass("folder-summary-chat__input"),n.placeholder="Ask a question...";let o=()=>{globalThis.setTimeout(()=>{n.scrollIntoView({block:"end",behavior:"auto"})},80)},r=()=>{let d=typeof globalThis.visualViewport?.height=="number"?globalThis.visualViewport.height:globalThis.innerHeight;this.modalEl.style.setProperty("--folder-summary-chat-vh",`${Math.max(320,Math.round(d))}px`);let T=typeof globalThis.visualViewport?.height=="number"&&typeof globalThis.visualViewport?.offsetTop=="number"?Math.max(0,Math.round(globalThis.innerHeight-(globalThis.visualViewport.height+globalThis.visualViewport.offsetTop))):0;this.modalEl.style.setProperty("--folder-summary-chat-keyboard-inset",`${T}px`),t.classList.toggle("folder-summary-chat--keyboard-open",T>20)};r();let l=globalThis.visualViewport;if(l){let d=()=>{r(),this.contentEl.ownerDocument.activeElement===n&&o()};l.addEventListener("resize",d),l.addEventListener("scroll",d),this.viewportTarget=l,this.viewportHandler=d}n.addEventListener("focus",()=>{r(),o()}),n.addEventListener("blur",()=>{globalThis.setTimeout(r,120)}),n.addEventListener("input",o);let h=t.createEl("button",{text:"Send"});h.addClass("folder-summary-chat__send");let u=d=>{this.isWaiting=d,n.disabled=d,d?(h.setText("Stop"),h.addClass("folder-summary-chat__send--stop")):(h.setText("Send"),h.removeClass("folder-summary-chat__send--stop"))},g=async()=>{let d=n.value.trim();if(!d||this.isWaiting)return;n.value="",this.appendMessage(i,"user",d),this.messages.push({role:"user",content:d}),await this.onLog("user",d),this.resetStreamingState();let T=this.appendLoadingMessage(i);i.scrollTop=i.scrollHeight,u(!0);let z=++this.requestCounter,B=new AbortController;this.currentAbort=B;let k="",L=!1,M=()=>{L||(L=!0,T.wrapper.removeClass("folder-summary-chat__message--loading"),T.body.empty(),T.body.addClass("folder-summary-chat__message-body--streaming"))};try{let E=await this.onStream(this.messages,this.useSummary?this.summary:"",P=>{M(),k+=P,this.updateStreamingMessage(T.body,k),i.scrollTop=i.scrollHeight},B.signal);if(this.canceledRequest===z)T.wrapper.remove();else{L||M();let P=E.message||k;if(this.messages.push({role:"assistant",content:P}),this.finalizeStreamingMessage(T.body,P),await this.onLog("assistant",P),E.artifactPaths.length>0){let G=this.renderArtifactStatus(T.wrapper,E.artifactPaths);this.onDownloadArtifacts(E.artifactPaths,(X,W)=>{let $=G.get(X);$&&($.status.setText(W),$.open.classList.toggle("folder-summary-chat__artifact-open--disabled",W!=="\u0433\u043E\u0442\u043E\u0432\u043E"))})}}}catch(E){if(this.canceledRequest!==z){let P=E instanceof Error?E.message:"Failed to fetch response.";P.toLowerCase().includes("abort")?T.wrapper.remove():(M(),this.updateStreamingMessage(T.body,P))}else T.wrapper.remove()}finally{u(!1),this.canceledRequest=null,this.currentAbort=null}i.scrollTop=i.scrollHeight};h.onclick=()=>{if(this.isWaiting){this.canceledRequest=this.requestCounter,this.currentAbort?.abort(),u(!1);return}g()},n.addEventListener("keydown",d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),g())});let f=t.createEl("div");f.addClass("folder-summary-chat__actions"),f.appendChild(h);let v=f.createEl("button",{text:"Summary"});v.addClass("folder-summary-chat__summary-open");let C=f.createEl("label");C.addClass("folder-summary-chat__summary-toggle");let F=C.createEl("input");F.type="checkbox",F.checked=!0,F.addClass("folder-summary-chat__summary-checkbox"),C.createEl("span").addClass("folder-summary-chat__summary-slider"),C.createEl("span",{text:"Use summary"}).addClass("folder-summary-chat__summary-toggle-label"),F.addEventListener("change",()=>{this.useSummary=F.checked});let w=t.createEl("div");w.addClass("folder-summary-chat__summary-sheet"),w.addClass("folder-summary-chat__summary-sheet--hidden"),w.setAttr("aria-hidden","true");let p=w.createEl("div");p.addClass("folder-summary-chat__summary-panel");let m=p.createEl("div");m.addClass("folder-summary-chat__summary-header"),m.createEl("div",{text:`Summary: ${this.folderLabel}`}).addClass("folder-summary-chat__summary-header-title");let b=m.createEl("button",{text:"Close"});b.addClass("folder-summary-chat__summary-close"),p.createEl("pre",{text:this.summary}).addClass("folder-summary-chat__summary-text");let Y=()=>{w.removeClass("folder-summary-chat__summary-sheet--hidden"),w.setAttr("aria-hidden","false"),b.focus()},_=()=>{w.addClass("folder-summary-chat__summary-sheet--hidden"),w.setAttr("aria-hidden","true")};v.onclick=()=>Y(),b.onclick=()=>_(),w.addEventListener("click",d=>{d.target===w&&_()}),t.addEventListener("keydown",d=>{d.key==="Escape"&&!w.classList.contains("folder-summary-chat__summary-sheet--hidden")&&(d.preventDefault(),_())}),globalThis.setTimeout(()=>{this.contentEl.ownerDocument.activeElement===a&&i.focus({preventScroll:!0})},0)}onClose(){this.currentAbort?.abort(),this.currentAbort=null,this.resetStreamingState(),this.viewportTarget&&this.viewportHandler&&(this.viewportTarget.removeEventListener("resize",this.viewportHandler),this.viewportTarget.removeEventListener("scroll",this.viewportHandler)),this.viewportTarget=null,this.viewportHandler=null,this.modalEl.style.removeProperty("--folder-summary-chat-vh"),this.modalEl.style.removeProperty("--folder-summary-chat-keyboard-inset"),this.modalEl.removeClass("folder-summary-chat-modal"),this.modalEl.removeClass("folder-summary-chat-modal--glass"),this.modalEl.removeClass("folder-summary-chat-modal--quiet"),this.contentEl.removeClass("folder-summary-chat--glass"),this.contentEl.removeClass("folder-summary-chat--quiet"),this.contentEl.removeClass("folder-summary-chat--keyboard-open"),this.contentEl.empty()}appendMessage(t,e,s){let a=t.createEl("div");a.addClass("folder-summary-chat__message"),a.addClass(e==="user"?"folder-summary-chat__message--user":"folder-summary-chat__message--assistant"),a.createEl("div",{text:e==="user"?"\u0412\u044B":"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let n=a.createEl("div");if(n.addClass("folder-summary-chat__message-body"),e==="assistant"){this.renderAssistantMarkdown(n,s);let o=a.createEl("div");o.addClass("folder-summary-chat__message-actions");let r=o.createEl("button",{text:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C"});r.addClass("folder-summary-chat__message-save"),r.onclick=()=>void this.onSave(s)}else n.setText(s)}appendLoadingMessage(t){let e=t.createEl("div");e.addClass("folder-summary-chat__message"),e.addClass("folder-summary-chat__message--assistant"),e.addClass("folder-summary-chat__message--loading"),e.createEl("div",{text:"\u041F\u043E\u043C\u043E\u0449\u043D\u0438\u043A"}).addClass("folder-summary-chat__message-title");let a=e.createEl("div");a.addClass("folder-summary-chat__message-body");let i=a.createEl("span");i.addClass("folder-summary-chat__loading-dots");for(let n=0;n<3;n+=1){let o=i.createEl("span",{text:"."});o.addClass("folder-summary-chat__loading-dot"),o.setAttr("aria-hidden","true")}return{wrapper:e,body:a}}updateStreamingMessage(t,e){t.addClass("folder-summary-chat__message-body--streaming"),this.updateTypingText(t,e)}finalizeStreamingMessage(t,e){this.queueFinalize(t,e)}renderAssistantMarkdown(t,e){t.empty(),c.MarkdownRenderer.render(this.app,e,t,this.markdownSourcePath,this.markdownComponent)}updateTypingText(t,e){this.streamingRenderTarget!==t&&(this.streamingRenderTarget=t,this.streamingTypingProgress=0),this.streamingRenderText=e,this.streamingTypingTimer===null&&(this.streamingTypingTimer=globalThis.setInterval(()=>this.tickStreamingTyping(),mt))}stopStreamingTyping(){this.streamingTypingTimer!==null&&(globalThis.clearInterval(this.streamingTypingTimer),this.streamingTypingTimer=null),this.streamingTypingProgress=0}tickStreamingTyping(){if(!this.streamingRenderTarget){this.stopStreamingTyping();return}let t=this.streamingRenderText;if(!t){this.stopStreamingTyping();return}let e=t.length-this.streamingTypingProgress;if(e<=0){if(this.streamingFinalizeTarget){let i=this.streamingFinalizeTarget;this.streamingFinalizeTarget=null,this.completeFinalize(i.body,i.text)}else this.stopStreamingTyping();return}let s=Math.ceil(e/pt),a=Math.max(dt,s);this.streamingTypingProgress=Math.min(t.length,this.streamingTypingProgress+a),this.streamingRenderTarget.setText(t.slice(0,this.streamingTypingProgress))}queueFinalize(t,e){this.streamingFinalizeTarget={body:t,text:e},this.streamingTypingTimer===null&&this.completeFinalize(t,e)}completeFinalize(t,e){this.stopStreamingTyping(),t.removeClass("folder-summary-chat__message-body--streaming"),this.renderAssistantMarkdown(t,e)}resetStreamingState(){this.stopStreamingTyping(),this.streamingRenderText="",this.streamingRenderTarget=null,this.streamingTypingProgress=0,this.streamingFinalizeTarget=null}renderArtifactStatus(t,e){let s=new Map;t.createEl("div",{text:"\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442\u044B"}).addClass("folder-summary-chat__artifact-title");let i=t.createEl("ul");i.addClass("folder-summary-chat__artifact-list");for(let n of e){let o=this.extractFilename(n),r=this.isArtifactDownloaded(n),l=i.createEl("li");l.addClass("folder-summary-chat__artifact-item");let h=l.createEl("a",{text:o});h.href="#",h.onclick=g=>{if(g.preventDefault(),h.classList.contains("folder-summary-chat__artifact-open--disabled")){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}this.openArtifact(n)},h.addClass("folder-summary-chat__artifact-name"),h.addClass("folder-summary-chat__artifact-open"),r||h.addClass("folder-summary-chat__artifact-open--disabled");let u=l.createEl("span",{text:r?"\u0433\u043E\u0442\u043E\u0432\u043E":"\u043E\u0436\u0438\u0434\u0430\u043D\u0438\u0435"});u.addClass("folder-summary-chat__artifact-status"),s.set(n,{status:u,open:h})}return s}getArtifactLocalPath(t){return`${this.markdownSourcePath?`${this.markdownSourcePath}/`:""}${K}/${J}/${this.extractFilename(t)}`}isArtifactDownloaded(t){return this.app.vault.getAbstractFileByPath(this.getArtifactLocalPath(t))instanceof c.TFile}async openArtifact(t){let e=this.getArtifactLocalPath(t),s=this.app.vault.getAbstractFileByPath(e);if(!(s instanceof c.TFile)){new c.Notice("\u0410\u0440\u0442\u0435\u0444\u0430\u043A\u0442 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043A\u0430\u0447\u0430\u043D.");return}await this.app.workspace.getLeaf(!0).openFile(s)}extractFilename(t){let e=t.split("?")[0],s=e.split("/").pop()??e;try{return decodeURIComponent(s)}catch{return s}}},N=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new c.Setting(t).setName("API host").setDesc("Host URL for the future summary/chat API.").addText(e=>e.setPlaceholder("https://api.example.com").setValue(this.plugin.settings.apiHost).onChange(async s=>{this.plugin.settings.apiHost=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("API key").setDesc("API key used for authentication.").addText(e=>e.setPlaceholder("API key").setValue(this.plugin.settings.apiKey).onChange(async s=>{this.plugin.settings.apiKey=s.trim(),await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary endpoint path").setDesc("Path for summary API (relative to host).").addText(e=>e.setPlaceholder("/summaries").setValue(this.plugin.settings.apiSummaryPath).onChange(async s=>{this.plugin.settings.apiSummaryPath=s.trim()||"/summaries",await this.plugin.saveSettings()})),new c.Setting(t).setName("Transcription endpoint path").setDesc("Path for audio transcription API (relative to host).").addText(e=>e.setPlaceholder("/transcriptions").setValue(this.plugin.settings.apiTranscriptionPath).onChange(async s=>{this.plugin.settings.apiTranscriptionPath=s.trim()||"/transcriptions",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat endpoint path").setDesc("Path for chat API (relative to host).").addText(e=>e.setPlaceholder("/chat").setValue(this.plugin.settings.apiChatPath).onChange(async s=>{this.plugin.settings.apiChatPath=s.trim()||"/chat",await this.plugin.saveSettings()})),new c.Setting(t).setName("Summary file name").setDesc("File name for the summary saved in the folder.").addText(e=>e.setPlaceholder("_summary.md").setValue(this.plugin.settings.summaryFileName).onChange(async s=>{this.plugin.settings.summaryFileName=s.trim()||"_summary.md",await this.plugin.saveSettings()})),new c.Setting(t).setName("Chat theme").setDesc("Visual style for the chat modal.").addDropdown(e=>e.addOption("glass","iOS glass").addOption("quiet","iOS calm").addOption("classic","iOS classic").setValue(this.plugin.settings.chatTheme).onChange(async s=>{this.plugin.settings.chatTheme=s==="classic"||s==="quiet"?s:"glass",await this.plugin.saveSettings()}))}},O=class extends c.Modal{constructor(){super(...arguments);this.statusEl=null}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("devbrief-progress"),e.createEl("div").addClass("devbrief-progress__spinner");let a=e.createEl("div",{text:"..."});a.addClass("devbrief-progress__status"),this.statusEl=a}setStatus(e){this.statusEl&&this.statusEl.setText(e)}onClose(){this.contentEl.empty(),this.statusEl=null}},D=class extends c.Modal{constructor(t,e){super(t),this.message=e}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("devbrief-error"),t.createEl("h3",{text:"\u041E\u0448\u0438\u0431\u043A\u0430"}),t.createEl("p",{text:"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0449\u0435\u043D\u0438\u0438 \u043A API."}),t.createEl("pre",{text:this.message})}onClose(){this.contentEl.empty()}};function V(y){let t="",e=new Uint8Array(y),s=8192;for(let a=0;a<e.length;a+=s){let i=e.subarray(a,a+s);t+=String.fromCharCode(...i)}if(typeof globalThis.btoa!="function")throw new Error("btoa is not available in this environment.");return globalThis.btoa(t)}
